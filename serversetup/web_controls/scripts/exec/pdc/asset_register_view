#!/bin/bash
#Copyright (C) 2007  Paul Sharrad
#Copyright (C) 2013  Robin McCorkell

#This file is part of Karoshi Server.
#
#Karoshi Server is free software: you can redistribute it and/or modify
#it under the terms of the GNU Affero General Public License as published by
#the Free Software Foundation, either version 3 of the License, or
#(at your option) any later version.
#
#Karoshi Server is distributed in the hope that it will be useful,
#but WITHOUT ANY WARRANTY; without even the implied warranty of
#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#GNU Affero General Public License for more details.
#
#You should have received a copy of the GNU Affero General Public License
#along with Karoshi Server.  If not, see <http://www.gnu.org/licenses/>.

#
#The Karoshi Team can be contacted at: 
#mpsharrad@karoshi.org.uk
#jsharrad@karoshi.org.uk

#
#Website: http://www.karoshi.org.uk
############################
#Language
############################

[ -f /opt/karoshi/web_controls/user_prefs/$REMOTE_USER/language_choice ] && source /opt/karoshi/web_controls/user_prefs/$REMOTE_USER/language_choice
TEXTDOMAIN=karoshi-server

LOG_DATE=`date +%F`
########################
#Check md5checksum
########################
if ! test -f /opt/karoshi/web_controls/checksums/admin_checksums/asset_register_view_cgi
then
	echo `date`: asset_register_view - No Admin MD5Checksum >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	exit 101
fi
source /opt/karoshi/web_controls/checksums/admin_checksums/asset_register_view_cgi
MD5SUM=`md5sum /var/www/cgi-bin_karoshi/admin/asset_register_view.cgi | cut -d' ' -f1`
[ -z "$MD5SUM" ] && MD5SUM=not_set
if [ $MD5SUM'check' != $asset_register_view_cgi'check' ]
then
	echo `date`: asset_register_view - Incorrect Admin MD5Checksum >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	exit 101
fi

if ! test -f /opt/karoshi/web_controls/checksums/tech_checksums/asset_register_view_cgi
then
	echo `date`: asset_register_view - No tech MD5Checksum >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	exit 101
fi
source /opt/karoshi/web_controls/checksums/tech_checksums/asset_register_view_cgi
MD5SUM2=`md5sum /var/www/cgi-bin_karoshi/tech/asset_register_view.cgi | cut -d' ' -f1`
[ -z "$MD5SUM2" ] && MD5SUM2=not_set
if [ $MD5SUM2'check' != $asset_register_view_cgi'check' ]
then
	echo `date`: asset_register_view - Incorrect Tech MD5Checksum >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	exit 101
fi
########################
#Get variables
########################
numArgs=$#
if [ $numArgs != 0 ]
then
	echo `date`: asset_register_view - incorrect number of arguments >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	exit 101
fi

read DATA
DATA=`echo $DATA | tr -cd 'A-Za-z0-9\._,:\-+%'`

REMOTE_USER=`echo "$DATA" | cut -s -d: -f1`
REMOTE_ADDR=`echo "$DATA" | cut -s -d: -f2`
REMOTE_MD5=`echo "$DATA" | cut -s -d: -f3`
MOBILE=`echo "$DATA" | cut -s -d: -f4`
LOCATION=`echo "$DATA" | cut -s -d: -f5 | sed 's/+/ /g'`
ACTION=`echo "$DATA" | cut -s -d: -f6`
ASSET=`echo "$DATA" | cut -s -d: -f7`
OPTION=`echo "$DATA" | cut -s -d: -f8`
ASSETCHOICE=`echo "$DATA" | cut -s -d: -f9`

########################
#Check data
########################
if [ $REMOTE_MD5'check' != $MD5SUM'check' ] && [ $REMOTE_MD5'check' != $MD5SUM2'check' ]
then
	echo `date`: asset_register_view - Not called by asset_register_view.cgi >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	exit 101
fi
if [ -z "$REMOTE_USER" ]
then
	echo `date`: asset_register_view - Blank remote user >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	exit 101
fi
if [ -z "$REMOTE_ADDR" ]
then
	echo `date`: asset_register_view - Blank remote tcpip address >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	exit 101
fi
if [ `grep -c ^$REMOTE_USER: /opt/karoshi/web_controls/web_access_admin` != 1 ] && [ `grep -c ^$REMOTE_USER: /opt/karoshi/web_controls/web_access_tech` != 1 ]
then
	echo `date`: asset_register_view - access denied to $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	exit 101
fi


if [ $MOBILE = yes ]
then
	TABLECLASS=mobilestandard
	ICON1=/images/assets/locationm.png
	ICON2=/images/assets/editm.png
	ICON3=/images/assets/deletem.png
	ICON4=/images/assets/add_assetm.png
	ICON5=/images/assets/totalsm.png
	ICON6=/images/assets/searchm.png
	ICON7=/images/assets/descriptionsm.png
	ICON8=/images/assets/addescm.png
	ICON9=/images/assets/suppliersm.png
	ICON10=/images/assets/adddescm.png
	ICON11=/images/assets/addsupplierm.png
	ICON12=/images/assets/budgetm.png
	ICON13=/images/assets/addbudgetm.png
	ICON14=/images/assets/moreinfom.png
	ICON15=/images/assets/exportm.png
	ICON16=/images/assets/importm.png
	ICON17=/images/assets/client_logsm.png
	ICON18=/images/assets/qrcodem.png
else
	TABLECLASS=standard
	ICON1=/images/assets/location.png
	ICON2=/images/assets/edit.png
	ICON3=/images/assets/delete.png
	ICON4=/images/assets/add_asset.png
	ICON5=/images/assets/totals.png
	ICON6=/images/assets/search.png
	ICON7=/images/assets/descriptions.png
	ICON8=/images/assets/addesc.png
	ICON9=/images/assets/suppliers.png
	ICON10=/images/assets/adddesc.png
	ICON11=/images/assets/addsupplier.png
	ICON12=/images/assets/budget.png
	ICON13=/images/assets/addbudget.png
	ICON14=/images/assets/moreinfo.png
	ICON15=/images/assets/export.png
	ICON16=/images/assets/import.png
	ICON17=/images/assets/client_logs.png
	ICON18=/images/assets/qrcode.png
fi


[ -z "$OPTION" ] && OPTION=nofilter

[ -z "$ACTION" ] && ACTION=view
[ -z "$LOCATION" ] && LOCATION=showchoice

#echo data is $DATA"<br>"
#echo action is $ACTION"<br>"
#echo location is $LOCATION"<br>"
#echo asset is $ASSET"<br>"


if [ $ACTION = qrcodes ]
then
	#Load asset_register_show_qrcodes.cgi
	echo '</form><form METHOD=POST ACTION="asset_register_show_qrcodes.cgi" target="_top" name="frm">
	<input type="hidden" name="_LOCATION_" value="'$LOCATION'">
	</form>
	<script>
	document.frm.submit();
	</script><form>
	'
fi

function assign_asset_labels {
ASSETLABEL=$"Curriculum Computer"
ASSETICON=/images/assets/curriculum_computer.png
if [ $ASSETTYPE = 2 ]
then
	ASSETICON=/images/assets/admin_computer.png ; ASSETLABEL=$"Admin Computer"
fi
if [ $ASSETTYPE = 3 ]
then
	ASSETICON=/images/assets/curriculum_laptop.png ; ASSETLABEL=$"Curriculum Laptop"
fi
if [ $ASSETTYPE = 4 ]
then
	ASSETICON=/images/assets/admin_laptop.png ; ASSETLABEL=$"Admin Laptop"
fi
if [ $ASSETTYPE = 5 ]
then
	ASSETICON=/images/assets/curriculum_tablet.png ; ASSETLABEL=$"Curriculum Tablet"
fi
if [ $ASSETTYPE = 6 ]
then
	ASSETICON=/images/assets/admin_tablet.png ; ASSETLABEL=$"Admin Tablet"
fi
if [ $ASSETTYPE = 7 ]
then
	ASSETICON=/images/assets/curriculum_pda.png ; ASSETLABEL=$"Curriculum PDA"
fi
if [ $ASSETTYPE = 8 ]
then
	ASSETICON=/images/assets/admin_pda.png ; ASSETLABEL=$"Admin PDA"
fi
if [ $ASSETTYPE = 9 ]
then
	ASSETICON=/images/assets/curriculum_thinclient.png ; ASSETLABEL=$"Curriculum Thin Client"
fi
if [ $ASSETTYPE = 10 ]
then
ASSETICON=/images/assets/admin_thinclient.png ; ASSETLABEL=$"Admin Thin Client"
fi
if [ $ASSETTYPE = 11 ]
then
ASSETICON=/images/assets/printer.png ; ASSETLABEL=$"Printer"
fi
if [ $ASSETTYPE = 12 ]
then
ASSETICON=/images/assets/scanner.png ; ASSETLABEL=$"Scanner"
fi
if [ $ASSETTYPE = 13 ]
then
	ASSETICON=/images/assets/projector.png ; ASSETLABEL=$"Projector"
fi
if [ $ASSETTYPE = 14 ]
then
	ASSETICON=/images/assets/whiteboard.png ; ASSETLABEL=$"Whiteboard"
fi
if [ $ASSETTYPE = 15 ]
then
ASSETICON=/images/assets/network_switch.png ; ASSETLABEL=$"Network Switch"
fi
if [ $ASSETTYPE = 16 ]
then
ASSETICON=/images/assets/network_device.png ; ASSETLABEL=$"Network Device"
fi
if [ $ASSETTYPE = 17 ]
then
	ASSETICON=/images/assets/wireless.png ; ASSETLABEL=$"Wireless Access Point"
fi
if [ $ASSETTYPE = 18 ]
then
ASSETICON=/images/assets/audio_visual.png ; ASSETLABEL=$"Audio Visual"
fi
if [ $ASSETTYPE = 19 ]
then
ASSETICON=/images/assets/monitor.png ; ASSETLABEL=$"Monitor"
fi
if [ $ASSETTYPE = 20 ]
then
	ASSETICON=/images/assets/software.png ; ASSETLABEL=$"Software"
fi
if [ $ASSETTYPE = 21 ]
then
	SSETICON=/images/assets/other.png ; ASSETLABEL=$"Other"
fi
}

##########################
#Show logs
##########################
if [ $ACTION = showlogs ]
then
	#Get asset details
	source /opt/karoshi/asset_register/locations/$LOCATION/$ASSET
	#Redirect to internet logs
	TODAY=`date +%d-%m-%Y`

	MD5SUM=`md5sum /var/www/cgi-bin_karoshi/admin/dg_view_computer_logs.cgi | cut -d' ' -f1`
	#View logs
	echo '</form><form action="dg_view_computer_logs.cgi" id="foo" method="post">
	<input name="_TCPIP_'$TCPIP1'_DATE_'$TODAY'_DAYCOUNT_1_" value="" type="hidden">
	</form>

	<script type="text/javascript">
	    function myfunc () {
		var frm = document.getElementById("foo");
		frm.submit();
	    }
	    window.onload = myfunc;
	</script>'
	ACTION=view
fi
##########################
#Export
##########################
if [ $ACTION = export ]
then
	echo '<b>'$"Asset Register"' - '$"Export"'</b><br><br><table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr>
	<td style="vertical-align: top;"><input name="_ACTION_view_" type="submit" class="button" value="'$"Choose Location"'"></td>
	<td style="vertical-align: top;"><input name="_ACTION_add_LOCATION_cm2_" type="submit" class="button" value="'$"Add Asset"'"></td>
	</tr></tbody></table>'

	[ $MOBILE != yes ] && echo '</div><div id="infobox">'

	echo '<textarea rows="100" cols="150">'
	echo $"Name",$"Location",$"Type",$"Description",$"Tcpip",$"Mac-address",$"S.N.",$"Purchased",$"Value",$"Supplier",$"Budget",$"Assigned to"
	for LOCATIONS in /opt/karoshi/asset_register/locations/*
	do
		LOCATION=`basename $LOCATIONS`
		for ASSETS in /opt/karoshi/asset_register/locations/$LOCATION/*
		do
			ASSET=`basename $ASSETS`
			source /opt/karoshi/asset_register/locations/$LOCATION/$ASSET
			assign_asset_labels
			echo $IDENTITY,$LOCATION,$ASSETLABEL,$DESCRIPTION,$TCPIP1 $TCPIP2 $TCPIP3,$MAC1 $MAC2 $MAC3,$SERIAL,$PURCHASEDATE,$VALUE,$SUPPLIER,$BUDGET,$ASSIGNED
		done
	done
	echo '</textarea>'
fi

##########################
#Add description
##########################
if [ $ACTION = adddesc ]
then
	echo '<b>'$"Add description"'</b><br><br><table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
	<tr><td style="width: 180px;">'$"Description"'</td><td><input tabindex= "1" name="_OPTION_" style="width: 200px;" size="20" type="text"></td><td>
	<a class="info" href="javascript:void(0)"><img class="images" alt="" src="/images/help/info.png"><span>'$"Add in a description that you want to appear in the description drop down list."'</span></a></td></tr></tbody></table><br><input name="_ACTION_reallyadddesc_" type="submit" class="button" value="'$"Submit"'"><a href="javascript:history.go(-1)"><input class="button" type="button" name="" value="'$"Cancel"'"></a>'
fi

if [ $ACTION = reallyadddesc ]
then
	echo `date`: asset_register_view - adding description $ASSET by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
		#Create folders
		[ ! -d /opt/karoshi/asset_register/descriptions ] && mkdir -p /opt/karoshi/asset_register/descriptions
		#Get Hardwaredesc number
		if [ -f /opt/karoshi/asset_register/.last_desc_number ]
		then
		DESC_NUMBER=`sed -n 1,1p /opt/karoshi/asset_register/.last_desc_number`
		let DESC_NUMBER=$DESC_NUMBER+1
	else
		DESC_NUMBER=1
	fi
	echo $DESC_NUMBER > /opt/karoshi/asset_register/.last_desc_number
	#Convert spaces
	OPTION=`echo $OPTION | sed 's/+/ /g'`
	#Add entry
	echo "$OPTION" > /opt/karoshi/asset_register/descriptions/$DESC_NUMBER
	#Rebuild asset list
	[ -f /opt/karoshi/asset_register/description_list ] && rm -f /opt/karoshi/asset_register/description_list
	for DESCRIPTIONFILES in /opt/karoshi/asset_register/descriptions/*
	do
		DESCRIPTIONFILE=`basename $DESCRIPTIONFILES`
		DESCRIPTION=`cat /opt/karoshi/asset_register/descriptions/$DESCRIPTIONFILE`
		echo '<option value="'$DESCRIPTION'">'$DESCRIPTION'</option>' >> /opt/karoshi/asset_register/description_list
	done
	#Sort description list
	sort /opt/karoshi/asset_register/description_list > /opt/karoshi/asset_register/description_list.$$
	rm -f /opt/karoshi/asset_register/description_list
	mv /opt/karoshi/asset_register/description_list.$$ /opt/karoshi/asset_register/description_list
	ACTION=viewdescriptions
	LOCATION=noset
fi

##########################
#Delete descriptions
##########################
if [ $ACTION = deletedescription ]
then
	if [ -f /opt/karoshi/asset_register/descriptions/$ASSET ]
	then
		#Delete description
		echo `date`: asset_register_view - deleting description $ASSET by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
		rm -f /opt/karoshi/asset_register/descriptions/$ASSET
		#Rebuild asset list
		if [ `ls -1 /opt/karoshi/asset_register/descriptions/ | wc -l` -gt 0 ]
		then
			[ -f /opt/karoshi/asset_register/description_list ] && rm -f /opt/karoshi/asset_register/description_list
			for DESCRIPTIONFILES in /opt/karoshi/asset_register/descriptions/*
			do
				DESCRIPTIONFILE=`basename $DESCRIPTIONFILES`
				DESCRIPTION=`cat /opt/karoshi/asset_register/descriptions/$DESCRIPTIONFILE`
				echo '<option value="'$DESCRIPTION'">'$DESCRIPTION'</option>' >> /opt/karoshi/asset_register/description_list
			done
			#Sort description list
			sort /opt/karoshi/asset_register/description_list > /opt/karoshi/asset_register/description_list.$$
			rm -f /opt/karoshi/asset_register/description_list
			mv /opt/karoshi/asset_register/description_list.$$ /opt/karoshi/asset_register/description_list
		fi
	fi
	ACTION=viewdescriptions
fi

##########################
#View descriptions
##########################
if [ $ACTION = viewdescriptions ]
then
	echo '<b>'$"Asset Register"' - '$"Descriptions"'</b><br><br><table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr>
	<td style="vertical-align: top;"><input name="_ACTION_view_" type="submit" class="button" value="'$"Choose Location"'"></td>
	<td style="vertical-align: top;"><input name="_ACTION_adddesc_LOCATION_notset_" type="submit" class="button" value="'$"Add Description"'"></td>
	</tr></tbody></table>'


	if [ `ls -1 /opt/karoshi/asset_register/descriptions/ | wc -l` -gt 0 ]
	then
		echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
		<tr><td style="width: 20px;"></td><td style="vertical-align: top;"><b>'$"Description"'</b></td></tr>'

		for DESCRIPTIONFILES in /opt/karoshi/asset_register/descriptions/*
		do
			DESCRIPTIONFILE=`basename $DESCRIPTIONFILES`
			DESCRIPTION=`cat /opt/karoshi/asset_register/descriptions/$DESCRIPTIONFILE`
			echo '<tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_deletedescription_LOCATION_notset_ASSET_'$DESCRIPTIONFILE'_" type="image" class="images" src="'$ICON3'" value=""><span>'$"Delete description"'</span></a></td><td>'$DESCRIPTION'</td></tr>'
		done
		echo '</tbody></table>'
	fi
fi

##########################
#Add supplier
##########################
if [ $ACTION = addsupplier ]
then
	echo '<b>'$"Add supplier"'</b><br><br><table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
	<tr><td style="width: 180px;">'$"Supplier"'</td><td><input tabindex= "1" name="_OPTION_" style="width: 200px;" size="20" type="text"></td><td>
	<a class="info" href="javascript:void(0)"><img class="images" alt="" src="/images/help/info.png"><span>'$"Add in the name of a supplier that you want to be available in the supplier drop down menu."'</span></a></td></tr></tbody></table><br><input name="_ACTION_reallyaddsupplier_" type="submit" class="button" value="'$"Submit"'"><a href="javascript:history.go(-1)"><input class="button" type="button" name="" value="'$"Cancel"'"></a>'


fi

if [ $ACTION = reallyaddsupplier ]
then
	echo `date`: asset_register_view - adding supplier $ASSET by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	#Create folders
	[ ! -d /opt/karoshi/asset_register/suppliers ] && mkdir -p /opt/karoshi/asset_register/suppliers
	#Get Hardwaredesc number
	if [ -f /opt/karoshi/asset_register/.last_supplier_number ]
	then
		SUP_NUMBER=`sed -n 1,1p /opt/karoshi/asset_register/.last_supplier_number`
		let SUP_NUMBER=$SUP_NUMBER+1
	else
		SUP_NUMBER=1
	fi
	echo $SUP_NUMBER > /opt/karoshi/asset_register/.last_supplier_number
	#Convert spaces
	OPTION=`echo $OPTION | sed 's/+/ /g'`
	#Add entry
	echo "$OPTION" > /opt/karoshi/asset_register/suppliers/$SUP_NUMBER
	#Rebuild supplier list
	[ -f /opt/karoshi/asset_register/supplier_list ] && rm -f /opt/karoshi/asset_register/supplier_list
	for SUPPLIERFILES in /opt/karoshi/asset_register/suppliers/*
	do
		SUPPLIERFILE=`basename $SUPPLIERFILES`
		SUPPLIER=`cat /opt/karoshi/asset_register/suppliers/$SUPPLIERFILE`
		echo '<option value="'$SUPPLIER'">'$SUPPLIER'</option>' >> /opt/karoshi/asset_register/supplier_list
	done

	#Sort supplier list
	sort /opt/karoshi/asset_register/supplier_list > /opt/karoshi/asset_register/supplier_list.$$
	rm -f /opt/karoshi/asset_register/supplier_list
	mv /opt/karoshi/asset_register/supplier_list.$$ /opt/karoshi/asset_register/supplier_list

	ACTION=viewsuppliers
	LOCATION=noset
fi

##########################
#Delete supplier
##########################
if [ $ACTION = deletesupplier ]
then
	if [ -f /opt/karoshi/asset_register/suppliers/$ASSET ]
	then
		#Delete supplier
		echo `date`: asset_register_view - deleting supplier $ASSET by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
		rm -f /opt/karoshi/asset_register/suppliers/$ASSET
		#Rebuild supplier list
		if [ `ls -1 /opt/karoshi/asset_register/suppliers/ | wc -l` -gt 0 ]
		then
			[ -f /opt/karoshi/asset_register/supplier_list ] && rm -f /opt/karoshi/asset_register/supplier_list
			for SUPPLIERFILES in /opt/karoshi/asset_register/suppliers/*
			do
				SUPPLIERFILE=`basename $SUPPLIERFILES`
				SUPPLIER=`cat /opt/karoshi/asset_register/suppliers/$SUPPLIERFILE`
				echo '<option value="'$SUPPLIER'">'$SUPPLIER'</option>' >> /opt/karoshi/asset_register/supplier_list
			done
			#Sort supplier list
			sort /opt/karoshi/asset_register/supplier_list > /opt/karoshi/asset_register/supplier_list.$$
			rm -f /opt/karoshi/asset_register/supplier_list
			mv /opt/karoshi/asset_register/supplier_list.$$ /opt/karoshi/asset_register/supplier_list
		fi
	fi
	ACTION=viewsuppliers
fi

##########################
#View Suppliers
##########################
if [ $ACTION = viewsuppliers ]
then
	echo '<b>'$"Asset Register"' - '$"Suppliers"'</b><br><br><table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr>
	<td style="vertical-align: top;"><input name="_ACTION_view_" type="submit" class="button" value="'$"Choose Location"'"></td>
	<td style="vertical-align: top;"><input name="_ACTION_addsupplier_LOCATION_notset_" type="submit" class="button" value="'$"Add Supplier"'"></td>
	</tr></tbody></table>'

	if [ -d /opt/karoshi/asset_register/suppliers/ ]
	then
		if [ `ls -1 /opt/karoshi/asset_register/suppliers/ | wc -l` -gt 0 ]
		then
			echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
			<tr><td style="width: 20px;"></td><td style="vertical-align: top;"><b>'$"Supplier"'</b></td></tr>'

			for SUPPLIERFILES in /opt/karoshi/asset_register/suppliers/*
			do
				SUPPLIERFILE=`basename $SUPPLIERFILES`
				SUPPLIER=`cat /opt/karoshi/asset_register/suppliers/$SUPPLIERFILE`
				echo '<tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_deletesupplier_LOCATION_notset_ASSET_'$SUPPLIERFILE'_" type="image" class="images" src="'$ICON3'" value=""><span>'$"Delete supplier"'</span></a></td><td>'$SUPPLIER'</td></tr>'
			done
			echo '</tbody></table>'
		fi
	fi
fi

##########################
#Add budget
##########################
if [ $ACTION = addbudget ]
then
	echo '<b>'$"Add budget"'</b><br><br><table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
	<tr><td style="width: 180px;">'$"Budget"'</td><td><input tabindex= "1" name="_OPTION_" style="width: 200px;" size="20" type="text"></td><td>
	<a class="info" href="javascript:void(0)"><img class="images" alt="" src="/images/help/info.png"><span>'$"Add in the name of a budget that you want to be available in the budget drop down menu."'</span></a></td></tr></tbody></table><br><input name="_ACTION_reallyaddbudget_" type="submit" class="button" value="'$"Submit"'"><a href="javascript:history.go(-1)"><input class="button" type="button" name="" value="'$"Cancel"'"></a>'
fi

if [ $ACTION = reallyaddbudget ]
then
	echo `date`: asset_register_view - adding budget $ASSET by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	#Create folders
	[ ! -d /opt/karoshi/asset_register/budgets ] && mkdir -p /opt/karoshi/asset_register/budgets
	#Get budget number
	if [ -f /opt/karoshi/asset_register/.last_budget_number ]
	then
		BUGET_NUMBER=`sed -n 1,1p /opt/karoshi/asset_register/.last_budget_number`
		let BUGET_NUMBER=$BUGET_NUMBER+1
	else
		BUGET_NUMBER=1
	fi
	echo $BUGET_NUMBER > /opt/karoshi/asset_register/.last_budget_number
	#Convert spaces
	OPTION=`echo $OPTION | sed 's/+/ /g'`
	#Add entry
	echo "$OPTION" > /opt/karoshi/asset_register/budgets/$BUGET_NUMBER
	#Rebuild budget list
	[ -f /opt/karoshi/asset_register/budget_list ] && rm -f /opt/karoshi/asset_register/budget_list
	for BUDGETFILES in /opt/karoshi/asset_register/budgets/*
		do
		BUDGETFILE=`basename $BUDGETFILES`
		BUDGET=`cat /opt/karoshi/asset_register/budgets/$BUDGETFILE`
		echo '<option value="'$BUDGET'">'$BUDGET'</option>' >> /opt/karoshi/asset_register/budget_list
	done
	ACTION=viewbudgets
	LOCATION=noset
fi

##########################
#Delete budget
##########################
if [ $ACTION = deletebudget ]
then
	if [ -f /opt/karoshi/asset_register/budgets/$ASSET ]
	then
		#Delete budget
		echo `date`: asset_register_view - deleting budget $ASSET by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
		rm -f /opt/karoshi/asset_register/budgets/$ASSET
		#Rebuild budget list
		if [ `ls -1 /opt/karoshi/asset_register/budgets/ | wc -l` -gt 0 ]
		then
			[ -f /opt/karoshi/asset_register/budget_list ] && rm -f /opt/karoshi/asset_register/budget_list
			for BUDGETFILES in /opt/karoshi/asset_register/budgets/*
			do
				BUDGETFILE=`basename $BUDGETFILES`
				BUDGET=`cat /opt/karoshi/asset_register/budgets/$BUDGETFILE`
				echo '<option value="'$BUDGET'">'$BUDGET'</option>' >> /opt/karoshi/asset_register/budget_list
			done
		fi
	fi
	ACTION=viewbudgets
fi

##########################
#View budgets
##########################
if [ $ACTION = viewbudgets ]
then
	echo '<b>'$"Asset Register"' - '$"Budgets"'</b><br><br><table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr>
	<td style="vertical-align: top;"><input name="_ACTION_view_" type="submit" class="button" value="'$"Choose Location"'"></td>
	<td style="vertical-align: top;"><input name="_ACTION_addbudget_LOCATION_notset_" type="submit" class="button" value="'$"Add Budget"'"></td>
	</tr></tbody></table>'

	if [ -d /opt/karoshi/asset_register/budgets/ ]
	then
		if [ `ls -1 /opt/karoshi/asset_register/budgets/ | wc -l` -gt 0 ]
		then
			echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
			<tr><td style="width: 20px;"></td><td style="vertical-align: top;"><b>'$"Budget"'</b></td></tr>'

			for BUDGETFILES in /opt/karoshi/asset_register/budgets/*
			do
				BUDGETFILE=`basename $BUDGETFILES`
				BUDGET=`cat /opt/karoshi/asset_register/budgets/$BUDGETFILE`
				echo '<tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_deletebudget_LOCATION_notset_ASSET_'$BUDGETFILE'_" type="image" class="images" src="'$ICON3'" value=""><span>'$"Delete budget"'</span></a></td><td>'$BUDGET'</td></tr>'
			done
			echo '</tbody></table>'
		fi
	fi
fi


if [ $ACTION = showstats ]
then
	echo '<b>'$"Statistics"'</b><br><br>'

	#Stats per room
	for LOCATIONS in /opt/karoshi/asset_register/locations/*
	do
		LOCATION=`basename $LOCATIONS`
		TOTAL1=`grep -h -R ASSETTYPE=\"1\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL2=`grep -h -R ASSETTYPE=\"2\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL3=`grep -h -R ASSETTYPE=\"3\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL4=`grep -h -R ASSETTYPE=\"4\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL5=`grep -h -R ASSETTYPE=\"5\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL6=`grep -h -R ASSETTYPE=\"6\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL7=`grep -h -R ASSETTYPE=\"7\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL8=`grep -h -R ASSETTYPE=\"8\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL9=`grep -h -R ASSETTYPE=\"9\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL10=`grep -h -R ASSETTYPE=\"10\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL11=`grep -h -R ASSETTYPE=\"11\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL12=`grep -h -R ASSETTYPE=\"12\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL13=`grep -h -R ASSETTYPE=\"13\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL14=`grep -h -R ASSETTYPE=\"14\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL15=`grep -h -R ASSETTYPE=\"15\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL16=`grep -h -R ASSETTYPE=\"16\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL17=`grep -h -R ASSETTYPE=\"17\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL18=`grep -h -R ASSETTYPE=\"18\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL19=`grep -h -R ASSETTYPE=\"19\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL20=`grep -h -R ASSETTYPE=\"20\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`
		TOTAL21=`grep -h -R ASSETTYPE=\"21\" /opt/karoshi/asset_register/locations/$LOCATION/* | wc -l`


		echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_view_LOCATION_'$LOCATION'_" type="image" class="images" src="'$ICON1'" value=""><span>'$"View Assets"'<br>'$LOCATION'</span></a></td><td><b>'$"Totals" - $LOCATION'</b></td></tr></tbody></table><br>'

		echo '<table class="'$TABLECLASS'" style="text-align: left; width: 100%;"><tbody>'
		echo '<tr><td>'$"Curriculum Computer"'</td><td>'$TOTAL1'</td><td>'$"Admin Computer"'</td><td>'$TOTAL2'</td><td>'$"Curriculum Laptop"'</td><td>'$TOTAL3'</td><td>'$"Admin Laptop"'</td><td>'$TOTAL4'</td></tr>
		<tr><td>'$"Curriculum Tablet"'</td><td>'$TOTAL5'</td><td>'$"Admin Tablet"'</td><td>'$TOTAL6'</td><td>'$"Curriculum PDA"'</td><td>'$TOTAL7'</td><td>'$"Admin PDA"'</td><td>'$TOTAL8'</td></tr>
		<tr><td>'$"Curriculum Thin Client"'</td><td>'$TOTAL9'</td><td>'$"Admin Thin Client"'</td><td>'$TOTAL10'</td><td>'$"Printer"'</td><td>'$TOTAL11'</td><td>'$"Scanner"'</td><td>'$TOTAL12'</td></tr>
		<tr><td>'$"Projector"'</td><td>'$TOTAL13'</td><td>'$"Whiteboard"'</td><td>'$TOTAL14'</td><td>'$"Network Switch"'</td><td>'$TOTAL15'</td><td>'$"Network Device"'</td><td>'$TOTAL16'</td></tr>
		<tr><td>'$"Wireless Access Point"'</td><td>'$TOTAL17'</td><td>'$"Audio Visual"'</td><td>'$TOTAL18'</td><td>'$"Monitor"'</td><td>'$TOTAL19'</td><td>'$"Software"'</td><td>'$TOTAL20'</td></tr>
		<tr><td>'$"Other"'</td><td>'$TOTAL21'</td></tr>
		</tbody></table><br>'
	done

	#Total stats
	TOTAL1=`grep -h -R ASSETTYPE=\"1\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL2=`grep -h -R ASSETTYPE=\"2\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL3=`grep -h -R ASSETTYPE=\"3\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL4=`grep -h -R ASSETTYPE=\"4\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL5=`grep -h -R ASSETTYPE=\"5\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL6=`grep -h -R ASSETTYPE=\"6\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL7=`grep -h -R ASSETTYPE=\"7\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL8=`grep -h -R ASSETTYPE=\"8\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL9=`grep -h -R ASSETTYPE=\"9\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL10=`grep -h -R ASSETTYPE=\"10\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL11=`grep -h -R ASSETTYPE=\"11\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL12=`grep -h -R ASSETTYPE=\"12\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL13=`grep -h -R ASSETTYPE=\"13\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL14=`grep -h -R ASSETTYPE=\"14\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL15=`grep -h -R ASSETTYPE=\"15\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL16=`grep -h -R ASSETTYPE=\"16\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL17=`grep -h -R ASSETTYPE=\"17\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL18=`grep -h -R ASSETTYPE=\"18\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL19=`grep -h -R ASSETTYPE=\"19\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL20=`grep -h -R ASSETTYPE=\"20\" /opt/karoshi/asset_register/locations/* | wc -l`
	TOTAL21=`grep -h -R ASSETTYPE=\"21\" /opt/karoshi/asset_register/locations/* | wc -l`
	echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_view_" type="image" class="images" src="'$ICON1'" value=""><span>'$"View Assets"'</span></a></td><td><b>'$"Totals"'</b></td></tr></tbody></table><br>'
	echo '<table class="'$TABLECLASS'" style="text-align: left; width: 100%;"><tbody>'
	echo "<tr><td>$"Curriculum Computer"</td><td>$TOTAL1</td><td>$"Admin Computer"</td><td>$TOTAL2</td><td>$"Curriculum Laptop"</td><td>$TOTAL3</td><td>$"Admin Laptop"</td><td>$TOTAL4</td></tr>"
	echo "<tr><td>$"Curriculum Tablet"</td><td>$TOTAL5</td><td>$"Admin Tablet"</td><td>$TOTAL6</td><td>$"Curriculum PDA"</td><td>$TOTAL7</td><td>$"Admin PDA"</td><td>$TOTAL8</td></tr>"
	echo "<tr><td>$"Curriculum Thin Client"</td><td>$TOTAL9</td><td>$"Admin Thin Client"</td><td>$TOTAL10</td><td>$"Printer"</td><td>$TOTAL11</td><td>$"Scanner"</td><td>$TOTAL12</td></tr>"
	echo "<tr><td>$"Projector"</td><td>$TOTAL13</td><td>$"Whiteboard"</td><td>$TOTAL14</td><td>$"Network Switch"</td><td>$TOTAL15</td><td>$"Network Device"</td><td>$TOTAL16</td></tr>"
	echo "<tr><td>$"Wireless Access Point"</td><td>$TOTAL17</td><td>$"Audio Visual"</td><td>$TOTAL18</td><td>$"Monitor"</td><td>$TOTAL19</td><td>$"Software"</td><td>$TOTAL20</td></tr>"
	echo "<tr><td>$"Other"</td><td>$TOTAL21</td></tr>"
	echo "</tbody></table><br>"
fi

############################
#Show choice of locations
############################
[ ! -d /opt/karoshi/asset_register/locations/ ] && mkdir -p /opt/karoshi/asset_register/locations/

if [ $LOCATION = showchoice ]
then
ROWCOUNT=6
[ $MOBILE = yes ] && ROWCOUNT=3
WIDTH=90
[ $MOBILE = yes ] && WIDTH=70

echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr><td style="vertical-align: top; height: 30px; width: '$WIDTH'px;"><b>'$"Statistics"'</b></td><td style="vertical-align: top; height: 30px; width: '$WIDTH'px;"><b>'$"Search"'</b></td>
<td style="vertical-align: top; height: 30px; width: '$WIDTH'px;"><b>'$"Import"'</b></td>
<td style="vertical-align: top; height: 30px; width: '$WIDTH'px;"><b>'$"Export"'</b></td></tr>
<tr><td style="vertical-align: top; height: 30px;"><a class="info" href="javascript:void(0)"><input name="_ACTION_showstats_LOCATION_notset_" type="image" class="images" src="'$ICON5'" value=""><span>'$"Statistics"'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_search_LOCATION_notset_" type="image" class="images" src="'$ICON6'" value=""><span>'$"Search"'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_import_LOCATION_notset_" type="image" class="images" src="'$ICON16'" value=""><span>'$"Import"'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_export_LOCATION_notset_" type="image" class="images" src="'$ICON15'" value=""><span>'$"Export"'</span></a></td>
</tr><tr>
<td style="vertical-align: top; height: 30px;"><b>'$"Add Asset"'</b></td><td style="vertical-align: top; height: 30px; width: '$WIDTH'px;"><b>'$"Descriptions"'</b></td><td style="vertical-align: top; height: 30px; width: '$WIDTH'px;"><b>'$"Suppliers"'</b></td><td style="vertical-align: top; height: 30px; width: '$WIDTH'px;"><b>'$"Budgets"'</b></td>
</tr><tr>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_add_LOCATION_notset_" type="image" class="images" src="'$ICON4'" value=""><span>'$"Add Asset"'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_viewdescriptions_LOCATION_notset_" type="image" class="images" src="'$ICON7'" value=""><span>'$"Description"'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_viewsuppliers_LOCATION_notset_" type="image" class="images" src="'$ICON9'" value=""><span>'$"Suppliers"'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_viewbudgets_LOCATION_notset_" type="image" class="images" src="'$ICON12'" value=""><span>'$"Budgets"'</span></a></td>
</tr></tbody></table><br>'
if [ `ls -1 /opt/karoshi/asset_register/locations/ | wc -l`  -gt 0 ]
then
echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr><td style="vertical-align: top;"><b>'$"View Assets"' - Choose Location</b></td></tr></tbody></table><br>'

[ $MOBILE != yes ] && echo '</div><div id="infobox">'

echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr>'
LOCCOUNTER=1
LOCATIONARRAY=( `ls /opt/karoshi/asset_register/locations/ | sort -f` )
ARRAYCOUNT=0
ARRAYMAX=${#LOCATIONARRAY[@]}
while [ $ARRAYCOUNT -lt $ARRAYMAX ]
do
LOCATION=${LOCATIONARRAY[$ARRAYCOUNT]}
echo '<td style="width: '$WIDTH'px; vertical-align: top; text-align: left;"><a class="info" href="javascript:void(0)"><input name="_ACTION_view_LOCATION_'$LOCATION'_" type="image" class="images" src="'$ICON1'" value=""><span>'$"View Assets"'<br>'$LOCATION'</span></a><br>'$LOCATION'</td>'
[ $LOCCOUNTER = $ROWCOUNT ] && echo '</tr><tr>'
let LOCCOUNTER=$LOCCOUNTER+1
[ $LOCCOUNTER -gt $ROWCOUNT ] && LOCCOUNTER=1
let ARRAYCOUNT=$ARRAYCOUNT+1
done
echo "</tr></tbody></table><br>"
LOCATION=showchoice
fi
fi

##########################
#Delete assets
##########################
if [ $ACTION = delete ]
then
	if [ ! -z "$ASSET" ]
	then
		if [ -f /opt/karoshi/asset_register/locations/$LOCATION/$ASSET ]
		then
			source /opt/karoshi/asset_register/locations/$LOCATION/$ASSET
			echo '<b>'$"Delete Assets"'</b><br><br>'
			echo $"Delete" $IDENTITY'<br><br>'$"Are you sure that you want to delete this item?"'<br><br>'
			echo '<input name="_ACTION_reallydelete_LOCATION_'$LOCATION'_ASSET_'$ASSET'_" type="submit" class="button" value="'$"Delete"'"><a href="javascript:history.go(-1)"><input class="button" type="button" name="" value="'$"Cancel"'"></a>'
		else
			echo No data "file" exists "for" this asset.
		fi
	else
		echo no asset set.
	fi
fi

if [ $ACTION = reallydelete ]
then
	ACTION=view
	if [ ! -z "$ASSET" ]
	then
		if [ -f /opt/karoshi/asset_register/locations/$LOCATION/$ASSET ]
		then
			[ ! -d /opt/karoshi/asset_register/deleted/$LOCATION/ ] && mkdir -p /opt/karoshi/asset_register/deleted/$LOCATION/
			source /opt/karoshi/asset_register/locations/$LOCATION/$ASSET
			#Delete entry from netlogon
			[ -f /var/lib/samba/netlogon/clients/$MAC1 ] && rm -f /var/lib/samba/netlogon/clients/$MAC1
			#Move entry to deleted folder
			mv -f /opt/karoshi/asset_register/locations/$LOCATION/$ASSET /opt/karoshi/asset_register/deleted/$LOCATION/
			echo `date`: asset_register_view - deleting $ASSET from $LOCATION by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
		fi
	fi
fi


function asset_form {

echo ' <input type="hidden" name="_ACTION_really'$ACTION'_ASSET_'$ASSET'_" value=""> 
<table style="text-align: left;" border="0" cellpadding="2" cellspacing="2" class="'$TABLECLASS'"><tbody>'
if [ "$ACTION" = edit ]
then
	echo '<tr><td style="width: 180px;">'$"Asset Number"'</td><td>'$ASSET'</td></tr>'
	else
	echo '<tr><td></td></tr>'
fi
echo '<tr><td style="width: 180px;">'$"Type"'</td><td>'
echo '<select name="_ASSETTYPE_" style="width: 200px;" tabindex= "1">'
[ $ACTION = edit ] && echo '<option value="'$ASSETTYPE'" selected="selected">Current</option>'
echo '<option value="1">'$"Curriculum Computer"'</option>'
echo '<option value="2">'$"Admin Computer"'</option>'
echo '<option value="3">'$"Curriculum Laptop"'</option>'
echo '<option value="4">'$"Admin Laptop"'</option>'
echo '<option value="5">'$"Curriculum Tablet"'</option>'
echo '<option value="6">'$"Admin Tablet"'</option>'
echo '<option value="7">'$"Curriculum PDA"'</option>'
echo '<option value="8">'$"Admin PDA"'</option>'
echo '<option value="9">'$"Curriculum Thin Client"'</option>'
echo '<option value="10">'$"Admin Thin Client"'</option>'
echo '<option value="11">'$"Printer"'</option>'
echo '<option value="12">'$"Scanner"'</option>'
echo '<option value="13">'$"Projector"'</option>'
echo '<option value="14">'$"Whiteboard"'</option>'
echo '<option value="15">'$"Network Switch"'</option>'
echo '<option value="16">'$"Network Device"'</option>'
echo '<option value="17">'$"Wireless Access Point"'</option>'
echo '<option value="18">'$"Audio Visual"'</option>'
echo '<option value="19">'$"Monitor"'</option>'
echo '<option value="20">'$"Software"'</option>'
echo '<option value="21">'$"Other"'</option>'
echo '<option value=""></option>'
echo '</select></td>'
#Value
echo '<td style="width: 180px;">'$"Value"'</td><td><input size="17" name="_VALUE_" value="'$VALUE'" style="width: 200px;" tabindex= "9" ></td></tr>'
#Location
echo '<tr><td>'$"Location"'<td><select name="_LOCATION_" style="width: 200px;" tabindex= "2">
<option value="'$LOCATION'">'$LOCATION'</option>'
COUNTER=1
if [ -f /var/lib/samba/netlogon/locations.txt ]
then
	LOCATION_COUNT=`cat /var/lib/samba/netlogon/locations.txt | wc -l`
else
	LOCATION_COUNT=0
fi
while [ $COUNTER -lt $LOCATION_COUNT ]
do
	LOCATION=`sed -n $COUNTER,$COUNTER'p' /var/lib/samba/netlogon/locations.txt`
	echo '<option value="'$LOCATION'">'$LOCATION'</option>'
	let COUNTER=$COUNTER+1
done
echo '</select></td>'
#Serial Code
DATE=`date +%d-%m-%y`
echo '<td>'$"Serial Number"'</td><td><input size="23" style="width: 200px;" value="'$SERIAL'" name="_SERIALKEY_" tabindex= "10"></td></tr>'
if [ "$ACTION" = edit ]
then
	#Identity
	echo '<tr><td>'$"Name"'</td><td>
	<input size="23" style="width: 200px;" value="'$IDENTITY'" name="_IDENTITY_" tabindex= "3">
	</td>'
else
	#os type
	echo '<tr><td>'$"OS Type"'</td><td>
	<select name="_IDENTITY_" style="width: 200px;" tabindex= "3">
	<option value=""></option>
        <option value="lx">Linux</option>
        <option value="mc">Mac</option>
        <option value="wn">Windows</option>
        <option value="or">Other</option>
	</select>
	</td>'
fi
#Assigned to
echo '<td>'$"Assigned to"'</td><td><input size="17" name="_ASSIGNED_" value="'$ASSIGNED'" style="width: 200px;" tabindex= "11"></td></tr>'
#Budget
echo '<tr><td><a href="/cgi-bin/admin/asset_register_add_budget_fm.cgi">'$"Budget"'</a></td><td><select name="_BUDGET_" style="width: 200px;" tabindex= "4">'
echo '<option value="'$BUDGET'">'$BUDGET'</option>'
[ -f /opt/karoshi/asset_register/supplier_list ] && cat /opt/karoshi/asset_register/budget_list
echo '<option value=""></option>'
echo '</select></td>'
#Asset Purchase date

[ $ACTION = add ] && PURCHASEDATE=`date +%d-%m-%y`

echo '<td>'$"Purchased"'</td><td><input maxlength="15" size="17" name="_PURCHASEDATE_" value="'$PURCHASEDATE'" style="width: 200px;" tabindex= "12"></td></tr>'
#Description
echo '<tr><td><a href="/cgi-bin/admin/asset_register_add_description_fm.cgi">'$"Description"'</a></td><td><select name="_DESCRIPTION_" style="width: 200px;" tabindex= "5">'
echo '<option value="'$DESCRIPTION'">'$DESCRIPTION'</option>'
[ -f /opt/karoshi/asset_register/description_list ] && cat /opt/karoshi/asset_register/description_list
echo '<option value=""></option>'
echo '</select></td>'
#Supplier
echo '<td><a href="/cgi-bin/admin/asset_register_add_supplier_fm.cgi">'$"Supplier"'</a></td><td><select name="_SUPPLIER_" style="width: 200px;" tabindex= "13">'
echo '<option value="'$SUPPLIER'">'$SUPPLIER'</option>'
[ -f /opt/karoshi/asset_register/supplier_list ] && cat /opt/karoshi/asset_register/supplier_list
echo '<option value=""></option></select></td></tr>'
#TCPIP1
echo '<tr><td>TCPIP 1</td><td><input maxlength="15" size="17" name="_TCPIP1_" value="'$TCPIP1'" style="width: 200px;" tabindex= "6"></td>'
#MAC Address1
echo '<td>'$"Mac Address"' 1</td><td><input maxlength="17" size="17" name="_MAC1_" value="'$MAC1'" style="width: 200px;" tabindex= "14"></td></tr>'
#TCPIP2
echo '<tr><td>TCPIP 2</td><td><input maxlength="15" size="17" name="_TCPIP2_" value="'$TCPIP2'" style="width: 200px;" tabindex= "7"></td>'
#MAC address2
echo '<td>'$"Mac Address"' 2</td><td><input maxlength="17" size="17" name="_MAC2_" value="'$MAC2'" style="width: 200px;" tabindex= "15"></td></tr>'
#TCPIP3
echo '<tr><td>TCPIP 3</td><td><input maxlength="15" size="17" name="_TCPIP3_" value="'$TCPIP3'" style="width: 200px;" tabindex= "8"></td>'
#MAC address3
echo '<td>'$"Mac Address"' 3</td><td><input maxlength="17" size="17" name="_MAC3_" value="'$MAC3'" style="width: 200px;" tabindex= "16"></td></tr>'
#Extra information
echo '<tr><td style="vertical-align: top;">'$"Extra Information"'</td><td colspan="3" rowspan="1" style="vertical-align: top;"><textarea style="width: 200px;" tabindex= "17" cols="100" rows="1" name="_EXTRAINFO_">'$EXTRAINFO'</textarea>
</td></tr>'
echo '</tbody></table><br><input name="" type="submit" class="button" value="'$"Submit"'"><a href="javascript:history.go(-1)"><input class="button" type="button" name="" value="'$"Cancel"'"></a>'

}

##########################
#Edit assets
##########################
if [ "$ACTION" = edit ]
then
	if [ ! -z "$ASSET" ]
	then
		if [ -f /opt/karoshi/asset_register/locations/$LOCATION/$ASSET ]
		then
			source /opt/karoshi/asset_register/locations/$LOCATION/$ASSET
			echo '<b>'$"Edit Asset"' - '$IDENTITY'</b><br><br>'
			asset_form
		else
			echo No data "file" exists "for" this asset.
		fi
	else
		echo no asset set.
	fi
fi


function get_asset_data {
ASSETTYPE=`echo "$DATA" | cut -s -d: -f10 | tr cd '0-9'`
[ -z "$ASSETTYPE" ] && ASSETTYPE=21
TCPIP1=`echo "$DATA" | cut -s -d: -f11`
TCPIP2=`echo "$DATA" | cut -s -d: -f12`
TCPIP3=`echo "$DATA" | cut -s -d: -f13`
MAC1=`echo "$DATA" | cut -s -d: -f14 | sed 's/%3A/:/g' | sed 's/-/:/g'`
MAC2=`echo "$DATA" | cut -s -d: -f15 | sed 's/%3A/:/g' | sed 's/-/:/g'`
MAC3=`echo "$DATA" | cut -s -d: -f16 | sed 's/%3A/:/g' | sed 's/-/:/g'`
SERIALKEY=`echo "$DATA" | cut -s -d: -f17`
PURCHASEDATE=`echo "$DATA" | cut -s -d: -f18`
IDENTITY=`echo "$DATA" | cut -s -d: -f19 | sed 's/+/ /g' | sed 's/%3A/:/g'`
DESCRIPTION=`echo "$DATA" | cut -s -d: -f20 | sed 's/+/ /g' | sed 's/%3A/:/g'`
ASSIGNED=`echo "$DATA" | cut -s -d: -f21 | sed 's/+/ /g'`
VALUE=`echo "$DATA" | cut -s -d: -f22 | sed 's/+/ /g' | sed 's/%A3/\&\#163;/g' | sed 's/%C2&#163;/Â£/g'`
SUPPLIER=`echo "$DATA" | cut -s -d: -f23 | sed 's/+/ /g' | sed 's/%3A/:/g'`
BUDGET=`echo "$DATA" | cut -s -d: -f24 | sed 's/+/ /g' | sed 's/%3A/:/g'`
EXTRAINFO=`echo "$DATA" | cut -s -d: -f26 | sed 's/+/ /g' | sed 's/%3A/:/g' | sed 's/%0D%0A/ /g'`
}

function write_asset_data {
[ ! -d "/opt/karoshi/asset_register/locations/$LOCATION/" ] && mkdir -p "/opt/karoshi/asset_register/locations/$LOCATION/"

[ $ACTION = reallyadd ] && IDENTITY=$IDENTITY$ASSET

echo ASSETTYPE=\""$ASSETTYPE"\" > "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo DESCRIPTION=\""$DESCRIPTION"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo IDENTITY=\""$IDENTITY"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo ASSIGNED=\""$ASSIGNED"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo TCPIP1=\""$TCPIP1"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo TCPIP2=\""$TCPIP2"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo TCPIP3=\""$TCPIP3"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo MAC1=\""$MAC1"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo MAC2=\""$MAC2"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo MAC3=\""$MAC3"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo SERIAL=\""$SERIALKEY"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo PURCHASEDATE=\""$PURCHASEDATE"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo VALUE=\""$VALUE"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo SUPPLIER=\""$SUPPLIER"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo BUDGET=\""$BUDGET"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"
echo EXTRAINFO=\""$EXTRAINFO"\" >> "/opt/karoshi/asset_register/locations/$LOCATION/$ASSET"

#Add details to netlogon
if [ ! -z "$MAC1" ]
then
	if [ $MAC1 != N.A. ]
	then
		if [ ! -d /var/lib/samba/netlogon/clients ]
		then
			mkdir /var/lib/samba/netlogon/clients
		fi
	CLIENTMAC=`echo $MAC1 | sed 's/://g'`
	echo $IDENTITY > /var/lib/samba/netlogon/clients/"$CLIENTMAC"
	echo $TCPIP1 >> /var/lib/samba/netlogon/clients/"$CLIENTMAC"
	echo $LOCATION >> /var/lib/samba/netlogon/clients/"$CLIENTMAC"
	fi
fi

if [ ! -z "$MAC2" ]
then
	if [ $MAC2 != N.A. ]
	then
		CLIENTMAC=`echo $MAC2 | sed 's/://g'`
		echo $IDENTITY > /var/lib/samba/netlogon/clients/"$CLIENTMAC"
		echo $TCPIP2 >> /var/lib/samba/netlogon/clients/"$CLIENTMAC"
		echo $LOCATION >> /var/lib/samba/netlogon/clients/"$CLIENTMAC"
	fi
fi


if [ ! -z "$MAC3" ]
then
	if [ $MAC3 != N.A. ]
	then
		CLIENTMAC=`echo $MAC3 | sed 's/://g'`
		echo $IDENTITY > /var/lib/samba/netlogon/clients/"$CLIENTMAC"
		echo $TCPIP3 >> /var/lib/samba/netlogon/clients/"$CLIENTMAC"
		echo $LOCATION >> /var/lib/samba/netlogon/clients/"$CLIENTMAC"
	fi
fi

if [[ $TCPIP1 ]] && [[ $TCPIP1 != "N.A." ]]; then
	LDAPPASS=`sed -n 1,1p /etc/ldap.secret`
	source /opt/karoshi/server_network/domain_information/domain_name
	
	#Add entry to dns for TCPIP1
	echo `date`: asset_register_view - checking "if" $IDENTITY is "in" the dns records by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	samba-tool dns query 127.0.0.1 $REALM $IDENTITY A --username=Administrator --password=$LDAPPASS 1>> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE 2>> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	if [ `echo $?` != 0 ]
	then
		echo `date`: asset_register_view - removing existing $IDENTITY $TCPIP1 from dns records by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
		samba-tool dns delete 127.0.0.1 $REALM $IDENTITY A $TCPIP1 --username=Administrator --password=$LDAPPASS 1>> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE 2>> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	fi
	echo `date`: asset_register_view - adding $IDENTITY $TCPIP1 to the dns records by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	samba-tool dns add 127.0.0.1 $REALM $IDENTITY A $TCPIP1 --username=Administrator --password=$LDAPPASS 1>> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE 2>> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	
	#Add reverse DNS entry for TCPIP1
	SUBNET=$(grep "netmask " /etc/network/interfaces | sed -n 1,1p | cut -d" " -f2)
	echo `date`: asset_register_view - adding a reverse DNS entry "for" $IDENTITY $TCPIP1 by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	/opt/karoshi/serversetup/pdc/"useful scripts"/reverse-dns add $TCPIP1 $SUBNET $IDENTITY.$REALM 1>/dev/null
fi
}

#Check for duplicate tcpip and mac addresses
function check_duplicate_data {
if [ ! -z "$SEARCHITEM" ]
then
	if [ `grep -R -h -w $SEARCHITEM /opt/karoshi/asset_register/locations/* | wc -l` -gt 0 ]
	then
		#Show error message and back button.
		echo ''$SEARCHITEM' - '$"This is already in use in the asset register."'<br><br><a href="javascript:history.go(-1)"> <img src="/images/submenus/file/back.gif" alt="back" border="0"></a><br><br>'
		exit
	fi
fi
}


function get_asset_number {
#Check that asset register is not locked
if [ -f /opt/karoshi/asset_register/.asset_lock ]
then
	echo $"The asset register is locked."
	exit 104
else
	#Create lock file
	touch /opt/karoshi/asset_register/.asset_lock
fi
#Get asset number
if [ -f /opt/karoshi/asset_register/.last_asset_number ]
then
	ASSET=`sed -n 1,1p /opt/karoshi/asset_register/.last_asset_number`
	let ASSET=$ASSET+1
else
	ASSET=1
fi
[ ! -d /opt/karoshi/asset_register ] && mkdir -p /opt/karoshi/asset_register
echo $ASSET > /opt/karoshi/asset_register/.last_asset_number
}


if [ $ACTION = reallyadd ]
then
	#Add asset
	get_asset_data

	#Check that tcpip and mac addresses are not already in use.
	if [ ! -z "$TCPIP1" ]
	then
		SEARCHITEM=$TCPIP1
		check_duplicate_data
	fi
	if [ ! -z "$TCPIP2" ]
	then
		SEARCHITEM=$TCPIP2
		check_duplicate_data
	fi
	if [ ! -z "$TCPIP3" ]
	then
		SEARCHITEM=$TCPIP3
		check_duplicate_data
	fi
	if [ ! -z "$MAC1" ]
	then
		SEARCHITEM=$MAC1
		check_duplicate_data
	fi
	if [ ! -z "$MAC2" ]
	then
		SEARCHITEM=$MAC2
		check_duplicate_data
	fi
	if [ ! -z "$MAC3" ]
	then
		SEARCHITEM=$MAC3
		check_duplicate_data
	fi

	get_asset_number

	echo `date`: asset_register_view - adding $IDENTITY to $LOCATION by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
	write_asset_data
	#Delete lock file
	rm -f /opt/karoshi/asset_register/.asset_lock
	ACTION=view
fi

if [ $ACTION = reallyedit ]
then
	ACTION=view
	if [ ! -z "$ASSET" ]
	then
		#Edit asset
		get_asset_data

		echo `date`: asset_register_view - editing $IDENTITY from $LOCATION by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
		#Delete asset 

		CURRENT_ASSETPATH=`find /opt/karoshi/asset_register/locations -name $ASSET`

		[ -f $CURRENT_ASSETPATH ] && rm -f $CURRENT_ASSETPATH 

		#Check that tcpip and mac addresses are not already in use.
		if [ ! -z "$TCPIP1" ]
		then
			SEARCHITEM=$TCPIP1
			check_duplicate_data
		fi
		if [ ! -z "$TCPIP2" ]
		then
			SEARCHITEM=$TCPIP2
			check_duplicate_data
		fi
		if [ ! -z "$TCPIP3" ]
		then
			SEARCHITEM=$TCPIP3
			check_duplicate_data
		fi
		if [ ! -z "$MAC1" ]
		then
			SEARCHITEM=$MAC1
			check_duplicate_data
		fi
		if [ ! -z "$MAC2" ]
		then
			SEARCHITEM=$MAC2
			check_duplicate_data
		fi
		if [ ! -z "$MAC3" ]
		then
			SEARCHITEM=$MAC3
			check_duplicate_data
		fi

		#Write asset 
		write_asset_data

	fi
fi

if [ $ACTION = add ]
then
	echo '<b>'$"Add Asset"'</b><br><br>'
	asset_form
fi

############################
#Show assets in a location 
############################
if [ $ACTION = view ] && [ $LOCATION != showchoice ]
then

if [ $OPTION = filter ]
then
ASSETTYPE=$ASSETCHOICE
assign_asset_labels
echo '<b>'$"Asset Register"' - '$LOCATION'</b><br><br><table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr>
<td style="vertical-align: top;"><input name="_ACTION_view_LOCATION_'$LOCATION'_ASSETCHOICE_'$ASSETTYPE'_OPTION_nofilter_" type="submit" class="button" value="'$"Show all assets"'"></td>
<td style="vertical-align: top;"><input name="_ACTION_view_" type="submit" class="button" value="'$"Choose Location"'"></td>'

[ $MOBILE = yes ] && echo '</tr><tr>'

echo '<td style="vertical-align: top;"><input name="_ACTION_add_LOCATION_'$LOCATION'_" type="submit" class="button" value="'$"Add Asset"'"></td>'
if [ -f /opt/karoshi/server_network/distribution_server ]
then 
echo '<td style="vertical-align: top;"></form><form action="client_boot_controls.cgi" id="foo" method="post"><input name="_LOCATION_'$LOCATION'_" type="submit" class="button" value="'$"Client Boot Controls"'"></form><form action="asset_register_view.cgi" id="foo" method="post"></td>'
fi
echo '</tr></tbody></table>
'
else
echo '<b>'$"Asset Register"' - '$LOCATION'</b><br><br><table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody><tr>
<td style="vertical-align: top;"><input name="_ACTION_view_" type="submit" class="button" value="'$"Choose Location"'"></td>
<td style="vertical-align: top;"><input name="_ACTION_add_LOCATION_'$LOCATION'_" type="submit" class="button" value="'$"Add Asset"'"></td>'

[ $MOBILE = yes ] && echo '</tr><tr>'

echo '<td style="vertical-align: top;"><input name="_ACTION_qrcodes_LOCATION_'$LOCATION'_" type="submit" class="button" value="'$"QR Codes"'"></td>'
if [ -f /opt/karoshi/server_network/distribution_server ]
then 
echo '<td style="vertical-align: top;"></form><form action="client_boot_controls.cgi" id="foo" method="post"><input name="_LOCATION_'$LOCATION'_" type="submit" class="button" value="'$"Client Boot Controls"'"></form><form action="asset_register_view.cgi" id="foo" method="post"></td>'
fi
echo '</tr></tbody></table>
'
fi

[ $MOBILE != yes ] && echo '</div><div id="infobox">'

if [ `ls -1 /opt/karoshi/asset_register/locations/$LOCATION/ | wc -l` -gt 0 ]
then
echo '
<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
<tr><td style="width: 20px;"></td><td style="width: 20px;"></td><td style="width: 20px;"></td><td style="width: 20px;"></td><td style="width: 20px;"></td>'

if [ $MOBILE = no ]
then
echo '<td style="width: 60px;"><b>'$"Name"'</b></td><td style="width: 240px;"><b>'$"Description"'</b></td><td style="width: 100px;"><b>'$"Tcpip"'</b></td><td style="width: 110px;"><b>'$"Mac-address"'</b></td><td style="width: 30px;"><b>'$"S.N."'</b></td></tr>'
else
echo '</tr>'
fi
for ASSETS in /opt/karoshi/asset_register/locations/$LOCATION/*
do
ASSET=`basename $ASSETS`
#Get asset information
source /opt/karoshi/asset_register/locations/$LOCATION/$ASSET
assign_asset_labels
SHOWENTRY=yes
if [ $OPTION = filter ]
then
SHOWENTRY=no
[ $ASSETTYPE = $ASSETCHOICE ] && SHOWENTRY=yes
fi
if [ $SHOWENTRY = yes ]
then
echo '<tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><img class="images" alt="" src="/images/help/info.png"><span>'$"Assigned"' : '$ASSIGNED'<br>'$"Purchased"' : '$PURCHASEDATE'<br>'$"Value"' : '$VALUE'<br>'$"Supplier"' : '$SUPPLIER'<br>'$"Budget"' : '$BUDGET'<br>'$"Tcpip"'<br>'$TCPIP1' '$TCPIP2' '$TCPIP3'<br>'$"Mac-address"'<br>'$MAC1' '$MAC2' '$MAC3'</span></a></td><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_edit_LOCATION_'$LOCATION'_ASSET_'$ASSET'_" type="image" class="images" src="'$ICON2'" value=""><span>'$"Edit"' '$IDENTITY'</span></a></td><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_delete_LOCATION_'$LOCATION'_ASSET_'$ASSET'_" type="image" class="images" src="'$ICON3'" value=""><span>'$"Delete"' '$IDENTITY'</span></a></td>
<td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_view_LOCATION_'$LOCATION'_ASSETCHOICE_'$ASSETTYPE'_OPTION_filter_" type="image" class="images" src="'$ASSETICON'" value=""><span>'$ASSETLABEL'</span></a></td>
<td style="vertical-align: top;">'
if [ $ASSETTYPE -le 8 ]
then
echo '<a class="info" href="javascript:void(0)"><input name="_ACTION_showlogs_LOCATION_'$LOCATION'_ASSET_'$ASSET'_" type="image" class="images" src="'$ICON17'" value=""><span>Show logs '$IDENTITY'</span></a></td>'
fi
echo '<td style="vertical-align: top;">'$IDENTITY'</td>'
if [ $MOBILE = no ]
then
echo '<td style="vertical-align: top;">'$DESCRIPTION'</td><td style="vertical-align: top;">'$TCPIP1' '$TCPIP2' '$TCPIP3'</td><td style="vertical-align: top;">'$MAC1' '$MAC2' '$MAC3'</td><td style="vertical-align: top;">'$SERIAL'</td></tr>'
else
echo '</tr>'
fi
fi
done
echo '</tbody></table>'
else
echo $"There are no assets allocated to this location."
fi
fi

########################
#Search
########################
if [ $ACTION = search ]
then
	echo '<b>'$"Search Assets"'</b><br><br>
	<input type="image" src="/images/submenus/file/go.gif" name="_ACTION_reallysearch_LOCATION_notset_" value="">
	<a href="javascript:history.go(-1)"> <img src="/images/submenus/file/back.gif" alt="back" border="0"></a><br>
	<table class="'$TABLECLASS'" style="text-align: left; height: 30px;" border="0" cellpadding="2" cellspacing="2"><tbody>
	<tr><td style="width: 200px;">'$"Search"'</td><td><input name="_OPTION_" size="20" type="text"></td><td><a class="info" href="javascript:void(0)"><img class="images" alt="" src="/images/help/info.png"><span>'$"Enter in the search criteria. This can be part of the mac address, serial number, purchase date, TCP-IP number etc."'</span></a></td></tr></tbody></table><br>'
fi

if [ "$ACTION" = reallysearch ]
then
	#Convert colons.
	OPTION=`echo $OPTION | sed 's/%3A/:/g'`

	echo '<b>'$"Search Assets"' - '$OPTION'</b><br><br>'

	[ $MOBILE != yes ] && echo '</div><div id="infobox">'

	echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2"><tbody>
	<tr><td style="width: 20px;"></td><td style="width: 20px;"></td><td style="width: 20px;"></td><td style="width: 20px;"></td><td style="width: 20px;"></td><td style="width: 60px;">'$"Name"'</td>'
	if [ $MOBILE = no ]
	then
		echo '<td style="width: 180px;">'$"Description"'</td><td style="width: 80px;">'$"Assigned"'</td><td style="width: 60px;">'$"Tcpip"'</td><td style="width: 60px;">'$"Mac-address"'</td><td style="width: 80px;">'$"S.N."'</td><td style="width: 60px;">'$"Purchased"'</td><td style="width: 60px;">'$"Value"'</td><td style="width: 80px;">'$"Supplier"'</td><td style="width: 180px;">'$"Budget"'</td></tr>'
	else
		echo '</tr>'
	fi

	for ASSETS in `grep -i -l -R $OPTION /opt/karoshi/asset_register/locations/*`
	do
		ASSET=`basename $ASSETS`
		LOCATION=`echo $ASSETS | cut -d"/" -f6`

		#Get asset information
		source /opt/karoshi/asset_register/locations/$LOCATION/$ASSET
		assign_asset_labels

		echo '<tr><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_view_LOCATION_'$LOCATION'_" type="image" class="images" src="'$ICON1'" value=""><span>'$"View Assets"'<br>'$LOCATION'</span></a></td><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_edit_LOCATION_'$LOCATION'_ASSET_'$ASSET'_" type="image" class="images" src="'$ICON2'" value=""><span>'$"Edit"' '$IDENTITY'</span></a></td><td style="vertical-align: top;"><a class="info" href="javascript:void(0)"><input name="_ACTION_delete_LOCATION_'$LOCATION'_ASSET_'$ASSET'_" type="image" class="images" src="'$ICON3'" value=""><span>'$"Delete"' '$IDENTITY'</span></a></td><td style="vertical-align: top;">

		<a class="info" href="javascript:void(0)"><input name="_ACTION_view_LOCATION_'$LOCATION'_ASSETCHOICE_'$ASSETTYPE'_OPTION_filter_" type="image" class="images" src="'$ASSETICON'" value=""><span>'$ASSETLABEL'</span></a>
		</td><td style="vertical-align: top;">'

		if [ $ASSETTYPE -le 8 ]
		then
			echo '<a class="info" href="javascript:void(0)"><input name="_ACTION_showlogs_LOCATION_'$LOCATION'_ASSET_'$ASSET'_" type="image" class="images" src="'$ICON17'" value=""><span>Show logs '$IDENTITY'</span></a>'
		fi

		echo '</td><td style="vertical-align: top;">'$IDENTITY'</td>'

		if [ $MOBILE = no ]
		then
			echo '<td style="vertical-align: top;">'$DESCRIPTION'</td><td style="vertical-align: top;">'$ASSIGNED'</td><td style="vertical-align: top;">
		'$TCPIP1' '$TCPIP2' '$TCPIP3'</td><td style="vertical-align: top;">'$MAC1' '$MAC2' '$MAC3'</td><td style="vertical-align: top;">'$SERIAL'</td><td style="vertical-align: top;">'$PURCHASEDATE'</td><td style="vertical-align: top;">'$VALUE'</td><td style="vertical-align: top;">'$SUPPLIER'</td><td style="vertical-align: top;">'$BUDGET'</td></tr>'
		else
			echo '</tr>'
		fi
	done
	echo '</tbody></table><br>'
fi

##########################
#Import
##########################
if [ "$ACTION" = import ]
then
	echo '<b>'$"Import data"'</b><br><br>
	<input type="image" src="/images/submenus/file/go.gif" name="_ACTION_reallyimport_" value="">
	<a href="javascript:history.go(-1)"> <img src="/images/submenus/file/back.gif" alt="back" border="0"></a><br><br>
	'$"Name"','$"Location"','$"Type"','$"Description"','$"Tcpip"','$"Mac-address"','$"S.N."','$"Purchased"','$"Value"','$"Supplier"','$"Budget"','$"Assigned to"'
	<textarea cols="150" rows="100" name="_LOCATION_notset_IMPORTDATA_"></textarea>
	'
fi

if [ "$ACTION" = reallyimport ]
then
	IMPORTDATA=`echo "$DATA" | cut -s -d: -f25 | sed 's/%2C/,/g' | sed 's/%0D%0A/\n/g'`
	TOTALCOUNT=`echo -e "$IMPORTDATA" | wc -l`

	echo '<b>'$"Number of assets to add"': '$TOTALCOUNT'</b><br><br>'

	COUNTER=1
	for DATALINE in `echo -e "$IMPORTDATA"`
	do
		IDENTITY=`echo "$DATALINE" | cut -s -d, -f1 | sed 's/+/ /g' | sed 's/%3A/:/g'`
		LOCATION=`echo "$DATALINE" | cut -s -d, -f2 | sed 's/+//g'`
		ASSETTYPE=`echo "$DATALINE" | cut -s -d, -f3 | tr -cd '0-9'`
		[ -z "$ASSETTYPE" ] && ASSETTYPE=21
		ASSETTYPE=`echo $ASSETTYPE | sed 's/+/ /g'`
		DESCRIPTION=`echo "$DATALINE" | cut -s -d, -f4 | sed 's/+/ /g' | sed 's/%3A/:/g'`

		TCPIPDATA=`echo "$DATALINE" | cut -s -d, -f5`

		TCPIP1=`echo $TCPIPDATA | cut -d'+' -f1`
		TCPIP2=`echo $TCPIPDATA | cut -s -d'+' -f2`
		TCPIP3=`echo $TCPIPDATA | cut -s -d'+' -f3`

		MACDATA=`echo "$DATALINE" | cut -s -d, -f6 | sed 's/+/ /g' | sed 's/%3A/:/g'`

		MAC1=`echo $MACDATA | cut -d' ' -f1`
		MAC2=`echo $MACDATA | cut -s -d' ' -f2`
		MAC3=`echo $MACDATA | cut -s -d' ' -f3`

		SERIALKEY=`echo "$DATALINE" | cut -s -d, -f7`
		PURCHASEDATE=`echo "$DATALINE" | cut -s -d, -f8`
		VALUE=`echo "$DATALINE" | cut -s -d, -f9 | sed 's/+/ /g' | sed 's/%A3/\&\#163;/g' | sed 's/%C2&#163;/Â£/g'`
		SUPPLIER=`echo "$DATALINE" | cut -s -d, -f10 | sed 's/+/ /g' | sed 's/%3A/:/g'`
		BUDGET=`echo "$DATALINE" | cut -s -d, -f11 | sed 's/+/ /g' | sed 's/%3A/:/g'`
		ASSIGNED=`echo "$DATALINE" | cut -s -d, -f12 | sed 's/+/ /g'`

		echo '<table class="'$TABLECLASS'" style="text-align: left;" border="0" cellpadding="2" cellspacing="2">
		<tbody><tr><td style="width: 180px;"><b>'$"Adding Asset"'</b></td><td><b>'$COUNTER'/'$TOTALCOUNT'</b></td></tr>
		<tr><td>'$"Identity"'</td><td>'$IDENTITY'</td></tr>
		<tr><td>'$"Location"'</td><td>'$LOCATION'</td></tr>
		<tr><td>'$"Type"'</td><td>'$ASSETTYPE'</td></tr>
		<tr><td>'$"Description"'</td><td>'$DESCRIPTION'</td></tr>
		<tr><td>'$"TCPIP"' 1</td><td>'$TCPIP1'</td></tr>
		<tr><td>'$"TCPIP"' 2</td><td>'$TCPIP2'</td></tr>
		<tr><td>'$"TCPIP"' 3</td><td>'$TCPIP3'</td></tr>
		<tr><td>'$"Mac Address"' 1</td><td>'$MAC1'</td></tr>
		<tr><td>'$"Mac Address"' 2</td><td>'$MAC2'</td></tr>
		<tr><td>'$"Mac Address"' 3</td><td>'$MAC3'</td></tr>
		<tr><td>'$"Serial Number"'</td><td>'$SERIALKEY'</td></tr>
		<tr><td>'$"Purchased"'</td><td>'$PURCHASEDATE'</td></tr>
		<tr><td>'$"Value"'</td><td>'$VALUE'</td></tr>
		<tr><td>'$"Supplier"'</td><td>'$SUPPLIER'</td></tr>
		<tr><td>'$"Budget"'</td><td>'$BUDGET'</td></tr>
		<tr><td>'$"Assigned to"'</td><td>'$ASSIGNED'</td></tr>
		</tbody></table><br>
		'

		#######################
		#Make sure that the location exists
		######################
		[ ! -f /var/lib/samba/netlogon/locations.txt ] && touch /var/lib/samba/netlogon/locations.txt
		ROOMCHECK=`grep -c -w "$LOCATION" /var/lib/samba/netlogon/locations.txt`
		if [ "$ROOMCHECK" = 0 ]
		then
			#Modify locations.txt
			echo $LOCATION >> /var/lib/samba/netlogon/locations.txt
			sort -f /var/lib/samba/netlogon/locations.txt > /var/lib/samba/netlogon/locations.tmp
			sed -i '/^$/d' /var/lib/samba/netlogon/locations.tmp
			mv -f /var/lib/samba/netlogon/locations.tmp /var/lib/samba/netlogon/locations.txt
			echo >> /var/lib/samba/netlogon/locations.txt
			rm -f /var/lib/samba/netlogon/locations.tmp

			###########################
			#Modify wsetup.kix
			###########################
			KIXLOCATIONLIST=`cat /var/lib/samba/netlogon/locations.txt | tr '\n' ','  | sed 's/,,/,/g' ; echo NoGroup`
			COMBOXBOX1LINENO=`grep -n '$'ComboBox1.List /var/lib/samba/netlogon/kix/WSsetup.kix | cut -d: -f1`
			sed $COMBOXBOX1LINENO'c'\$ComboBox1.List" "=" "$KIXLOCATIONLIST /var/lib/samba/netlogon/kix/WSsetup.kix > /var/lib/samba/netlogon/kix/WSsetup.kix1
			rm -f /var/lib/samba/netlogon/kix/WSsetup.kix
			mv /var/lib/samba/netlogon/kix/WSsetup.kix1 /var/lib/samba/netlogon/kix/WSsetup.kix
			chmod 0644 /var/lib/samba/netlogon/kix/WSsetup.kix
		fi

		#########################
		#Add in asset
		#########################
		get_asset_number
		echo `date`: asset_register_view - adding $IDENTITY to $LOCATION by $REMOTE_USER from $REMOTE_ADDR >> /opt/karoshi/logs/karoshi_web_management/$LOG_DATE
		write_asset_data
		#Delete lock file
		rm -f /opt/karoshi/asset_register/.asset_lock

		let COUNTER="$COUNTER"+1
	done
	#Show main page
	#View logs
	echo '</form><form action="asset_register_view.cgi" id="foo" method="post">
	<input name="_LOCATION_showchoice_" value="" type="hidden">
	</form>

	<script type="text/javascript">
	    function myfunc () {
		var frm = document.getElementById("foo");
		frm.submit();
	    }
	    window.onload = myfunc;
	</script>'

fi

exit

