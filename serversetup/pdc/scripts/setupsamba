#!/bin/bash
#setupsamba
#Copyright (C) 2004  Paul Sharrad
#This program is free software; you can redistribute it and/or
#modify it under the terms of the GNU General Public License
#as published by the Free Software Foundation; either version 2
#of the License, or (at your option) any later version.
#
#This program is distributed in the hope that it will be useful,
#but WITHOUT ANY WARRANTY; without even the implied warranty of
#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#GNU General Public License for more details.
#
#You should have received a copy of the GNU General Public License
#along with this program; if not, write to the Free Software
#Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
#
#The Karoshi Team can be contacted at: 
#mpsharrad@karoshi.org.uk
#jharris@karoshi.org.uk
#aloughlin@karoshi.org.uk
#
#Website: http://www.karoshi.org.uk
[ -d /opt/karoshi/.tempdata ] || mkdir /opt/karoshi/.tempdata

[ -e /opt/karoshi/serversetup/variables/language ] || /opt/karoshi/serversetup/changelanguage
[ -e /opt/karoshi/serversetup/variables/distro ] || /opt/karoshi/serversetup/changedistro

source /opt/karoshi/serversetup/variables/language
source /opt/karoshi/serversetup/variables/distro
source /opt/karoshi/serversetup/variables/years
source /opt/karoshi/serversetup/language/$LANGCHOICE/pdc/setupsamba
source /opt/karoshi/serversetup/language/$LANGCHOICE/softwareinstall
source /opt/karoshi/serversetup/distro/$DISTROCHOICE/pdc/software

#########################
#Add log entry
#########################
echo '##############'setupsamba'##############' >> /opt/karoshi/serversetup/install_log
date >> /opt/karoshi/serversetup/install_log
touch /opt/karoshi/serversetup/setuplog
if [ `grep -c "$TITLE" /opt/karoshi/serversetup/setuplog` = 0 ]
then
echo setupsamba:$TITLE:/opt/karoshi/serversetup/pdc/scripts/setupsamba >> /opt/karoshi/serversetup/setuplog
chmod 0600 /opt/karoshi/serversetup/setuplog
fi

THISYEAR=`date +%Y`
GUESTACCOUNTS=30
TECHACCOUNTS=4
EXAMACCOUNTS=40
TRAININGACCOUNTS=30
DAY=`date +%d`
MONTH=`date +%m`

#Install samba4
/opt/karoshi/serversetup/all/samba4/samba4install

######################
#Final samba Install check
######################

if [ ! -f /usr/local/sbin/samba ]
then
echo /usr/local/sbin/samba does not exist >> /opt/karoshi/serversetup/install_log
yad --title "$TITLE" --image="/opt/karoshi/serversetup/essentials/smalllogo.png" --window-icon="/opt/karoshi/serversetup/essentials/smalllogo.png" --timeout=4 --text="samba4 $NOTINSTALLED" --no-buttons
exit
fi

#######################
#Ensure that samba is running on boot
#######################
/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/startonboot/samba
#############################
#Copy in security settings
#############################
/opt/karoshi/serversetup/distro/$DISTROCHOICE/pdc/scripts/serverlevelsecurity

function show_info {
yad --title "$TITLE" --image="/opt/karoshi/serversetup/essentials/smalllogo.png" --window-icon="/opt/karoshi/serversetup/essentials/smalllogo.png" --width 600 --tail --no-buttons --text-info
}

function check_ldap_port {
#Check that samba 4 is ready for ldap requests
LDAPCHECK=0
COUNTER=0
while [ $LDAPCHECK = 0 ]
do
LDAPCHECK=`netstat -vatn | grep -c -w 389`
sleep 1
#Give up after 60 seconds
[ $COUNTER = 60 ] && exit 101
let COUNTER=$COUNTER+1
done
}

function getyadpid {
sleep 1
YADPID=`ps aux | grep yad | grep '\--tail' | sed 's/ * / /g' | cut -d' ' -f2`
}

###############################
#Get new root samba password
###############################
function getrootsmbpasswd {
DATA=`yad --image="/opt/karoshi/serversetup/essentials/smalllogo2.xpm" --window-icon="/opt/karoshi/serversetup/essentials/smalllogo.png" --form --title="$TITLE" --width 400 --wrap --text "$ROOTPASSWDMSG" --field="$ROOTPASSWDMSG4":H --field="$ROOTPASSWDMSG5":H --button=Ok`
SAMBAROOTPASSWORD1=`echo $DATA | cut -d"|" -f1`
SAMBAROOTPASSWORD2=`echo $DATA | cut -d"|" -f2`

echo $SAMBAROOTPASSWORD1 > /opt/karoshi/.tempdata/sambapassword
}

###############################
#Get domain name
###############################
function getdomainname {
DATA=`yad --image="/opt/karoshi/serversetup/essentials/smalllogo.png" --window-icon="/opt/karoshi/serversetup/essentials/smalllogo.png" --form --title="$TITLE" --width 500 --wrap --text "$DOMAINNAMEMSG1\n$DOMAINNAMEMSG2\n\n$EXAMPLEMSG\n\n$DOMAINNAMEMSG3:\t\ttestdomain.example.com\n$SITENAMEMSG:\tExample Institute of Technology\nShort Name:\tEIT\n" --field="$DOMAINNAMEMSG3" --field="$SITENAMEMSG" --field="$SHORTSITENAMEMSG" --button="gtk-ok"`
WEBADDRESS=`echo $DATA | cut -d"|" -f1 | tr -cd 'A-Za-z0-9.:/' | tr 'A-Z' 'a-z' | sed 's/^https:\/\///' | sed 's/^http:\/\///' | sed 's/^www.//g'`
LONGNAME=`echo $DATA | cut -d"|" -f2 | tr -cd 'A-Za-z0-9.: /' | sed 's/^https:\/\///' | sed 's/^http:\/\///' | sed 's/^www.//g'`
SHORTNAME=`echo $DATA | cut -d"|" -f3 | tr -cd 'A-Za-z0-9.: /' | sed 's/^https:\/\///' | sed 's/^http:\/\///' | sed 's/^www.//g'`
}

#Get domain name
getdomainname
while [ $WEBADDRESS'null' = null ]
do
getdomainname
done

#Create domain information

#Add .internal if only a short name is entered.
[ `echo $WEBADDRESS | tr -cd '.' | grep -c .` = 0 ] && WEBADDRESS=$WEBADDRESS.internal
SAMBADOMAIN=`echo $WEBADDRESS | cut -d. -f1`
SAMBADOMAINCAPS=`echo $SAMBADOMAIN | tr 'a-z' 'A-Z'`
REALM=$WEBADDRESS
REALMCAPS=`echo $WEBADDRESS | tr 'a-z' 'A-Z'`
LDAPBASE=`echo $WEBADDRESS | sed 's/\./,DC=/g' | sed 's/^/DC=/g'`

if [ ! -d /opt/karoshi/server_network/domain_information/ ]
then	
mkdir -p /opt/karoshi/server_network/domain_information/
fi
echo SAMBADOMAIN=\"$SAMBADOMAIN\" > /opt/karoshi/server_network/domain_information/domain_name
echo SAMBADOMAINCAPS=\"$SAMBADOMAINCAPS\" >> /opt/karoshi/server_network/domain_information/domain_name
echo WEBADDRESS=\"$WEBADDRESS\" >> /opt/karoshi/server_network/domain_information/domain_name
echo REALM=\"$WEBADDRESS\" >> /opt/karoshi/server_network/domain_information/domain_name
echo REALMCAPS=\"$REALMCAPS\" >> /opt/karoshi/server_network/domain_information/domain_name
echo LDAPBASE=\"$LDAPBASE\" >> /opt/karoshi/server_network/domain_information/domain_name
echo LONGNAME=\"$LONGNAME\" >> /opt/karoshi/server_network/domain_information/domain_name
echo SHORTNAME=\"$SHORTNAME\" >> /opt/karoshi/server_network/domain_information/domain_name
echo LINUXCLIENTVER=\"karoshi-2.2\" >> /opt/karoshi/server_network/domain_information/domain_name

function check_password {
#Check that passwords have been set
[ $SAMBAROOTPASSWORD1'null' = null ] && SAMBAROOTPASSWORD1=notset1
[ $SAMBAROOTPASSWORD2'null' = null ] && SAMBAROOTPASSWORD2=notset2

#Check that passwords match
if [ "$SAMBAROOTPASSWORD1" != "$SAMBAROOTPASSWORD2" ]
then
ROOTPASSWDMSG=`echo $ERRORMSG3 $ROOTPASSWDMSG1`
fi

#Get password length
PASSLENGTH=${#SAMBAROOTPASSWORD1}
if [ $PASSLENGTH -lt 8 ]
then
ROOTPASSWDMSG="$PASSWARN1"
SAMBAROOTPASSWORD2=$RANDOM
fi

#Check for upper and lowercase
if [ `echo "$SAMBAROOTPASSWORD1"'A' | tr -cd 'A-Z\n'` = A ]
then
SAMBAROOTPASSWORD2=$RANDOM
ROOTPASSWDMSG="$PASSWARN1"
fi
if [ `echo "$SAMBAROOTPASSWORD1"'a' | tr -cd 'a-z\n'` = a ]
then
ROOTPASSWDMSG="$PASSWARN1"
SAMBAROOTPASSWORD2=$RANDOM
fi
#Check for numbers
if [ `echo "$SAMBAROOTPASSWORD1"'1' | tr -cd '0-9\n'` = 1 ]
then
ROOTPASSWDMSG="$PASSWARN1"
SAMBAROOTPASSWORD2=$RANDOM
fi
}

#get samba root password
ROOTPASSWDMSG=`echo $ROOTPASSWDMSG1 $ROOTPASSWDMSG3`
getrootsmbpasswd
check_password
while [ "$SAMBAROOTPASSWORD1" != "$SAMBAROOTPASSWORD2" ]
do
#get samba root password
getrootsmbpasswd
check_password
done

LDAPPASS="$SAMBAROOTPASSWORD1"

#Add ldap password to /etc/ldap.secret
[ -f /etc/ldap.secret ] && rm -f /etc/ldap.secret
touch /etc/ldap.secret
chmod 0400 /etc/ldap.secret
echo $SAMBAROOTPASSWORD1 > /etc/ldap.secret

#Get forwarding dns server
DNSFORWARD=`grep dns-nameservers /etc/network/interfaces | cut -d" " -f2 | sed -n 1,1p`

#Get server ip
SERVERIP=`cat /etc/network/interfaces | grep address | cut -d' ' -f2 | sed -n 1,1p`
#Modify /etc/resolv.conf for samba4
echo domain $REALM > /etc/resolv.conf
echo nameserver $SERVERIP >> /etc/resolv.conf
echo nameserver 8.8.8.8 >> /etc/resolv.conf
echo nameserver 8.8.4.4 >> /etc/resolv.conf

function provision_samba4 {
echo Provisioning samba 4
#Delete smb.conf it exists
[ -f /etc/samba/smb.conf ] && rm -f /etc/samba/smb.conf
samba-tool domain provision --use-rfc2307 --realm=$REALM --domain=$SAMBADOMAIN --adminpass=''$SAMBAROOTPASSWORD1'' --server-role=dc 2>&1 | tee /opt/karoshi/server_network/domain_information/provisioning_info
}

function provisionsamba {
provision_samba4
getyadpid
if [ $YADPID'null' != null ]
then
kill $YADPID
fi
}

echo Provisioning samba4 >> /opt/karoshi/serversetup/install_log
provisionsamba 2>> /opt/karoshi/serversetup/install_log | show_info

#Get domain sid and add to domain information
DOMAINSID=`grep ^"DOMAIN SID:" /opt/karoshi/server_network/domain_information/provisioning_info | cut -d: -f2 | sed 's/ //g'`
echo DOMAINSID=\"$DOMAINSID\" >> /opt/karoshi/server_network/domain_information/domain_name

#Show domain information box

yad --title "Domain Information" --button="gtk-ok" --geometry=400x100-40+10 --image="/opt/karoshi/serversetup/essentials/smalllogo.png" --window-icon="/opt/karoshi/serversetup/essentials/smalllogo.png"  --text="$PROVISONMSG\n\n$INFORMATIONMSG :\n\n$FQDMSG\n$REALM\n\n$SHORTDOMAINMSG\n$SAMBADOMAIN\n\n$BASEDNMSG\n$LDAPBASE\n" &

#Configure kerberos
echo Configuring kerberos >> /opt/karoshi/serversetup/install_log
sed -i 's/${REALM}/'$REALMCAPS'/g' /usr/local/share/samba/setup/krb5.conf
#Copy in krb5.conf to etc
cp -f /usr/local/share/samba/setup/krb5.conf /etc/

#Add in dns entries

#samba-tool dns zonecreate <server> <reverse-network-ip-part>.in-addr.arpa -U Administrator
#samba-tool dns add <server> <zone> <host-part> PTR <domain-name> -U Administrator


#Create smb.conf
echo Creating smb.conf >> /opt/karoshi/serversetup/install_log
echo -e '# Global parameters
[global]
	workgroup = '$SAMBADOMAIN'
	realm = '$REALM'
	netbios name = '$HOSTNAME'
	server role = active directory domain controller
	dns forwarder = '$DNSFORWARD'
	idmap_ldb:use rfc2307 = yes
	acl:search=false

[netlogon]
	path = /var/lib/samba/netlogon
	read only = No

[sysvol]
	path = /var/lib/samba/sysvol
	read only = No

[homes]
	comment = Home Directories
	invalid users = root
	read only = No
	browseable = No
	veto files = /*.exe/*.msi/*.mp3/*.wma/*.ram/*.mov/*.mpg/*.mpeg/*.bat/*.lnk/*.zip/"Folder Settings"/desktop.ini/

[applications]
	comment = Data
	path = /home/applications
	invalid users = root
	read only = No
	guest ok = Yes
	browseable = No
	locking = No
	oplocks = No
	level2 oplocks = No

[itadmin]
	path = /home/itadminshare
	invalid users = root,administrator
	read only = No
	browseable = Yes

[staffshare]
	path = /home/staffshare
	invalid users = root,administrator
	read only = No
	browseable = Yes

[subjects]
	path = /home/subjects
	invalid users = root,administrator
	read only = No
	browseable = Yes

[netlogon]
	path = /var/lib/samba/netlogon
	invalid users = root,administrator
	create mask = 0664
	guest ok = Yes
	locking = No
	oplocks = No
	level2 oplocks = No

[officeshare]
	path = /home/officeshare
	invalid users = root,administrator
	read only = No
	browseable = Yes
' > /etc/samba/smb.conf

#Turn off complex password settings
echo Setting password settings >> /opt/karoshi/serversetup/install_log
samba-tool domain passwordsettings set --complexity=off
samba-tool domain passwordsettings set --min-pwd-length=3
samba-tool domain passwordsettings set --min-pwd-age=0
samba-tool domain passwordsettings set --max-pwd-age=999

#Add entry to /etc/hosts
echo $PDCIP"	"$HOSTNAME.$REALM"	"$HOSTNAME >> /etc/hosts
#Restart samba
echo Restarting samba4 >> /opt/karoshi/serversetup/install_log
/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/control_services/samba_stop
sleep 1
/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/control_services/samba_start
#Wait for port 389 on localhost to be available
check_ldap_port

#Add reverse dns entry
SUBNET=`grep "netmask " /etc/network/interfaces | sed -n 1,1p | cut -d" " -f2`
PDCIP=`hostname -I | cut -d" " -f1`
/opt/karoshi/serversetup/pdc/"useful scripts"/reverse-dns add $PDCIP $SUBNET $HOSTNAME.$REALM

###############################
#Create special user accounts for servers and linux clients to get user information from samba4 ldap
##############################
function random_pass {
RANGE=61
COUNTER=1
while [ $COUNTER -lt 16 ]
do
row[$COUNTER]=$RANDOM
let "row[$COUNTER] %= $RANGE"
while [ ${row[$COUNTER]} = 0 ]
do
row[$COUNTER]=$RANDOM
let "row[$COUNTER] %= $RANGE"
done
CHARACTER[$COUNTER]=`sed -n ${row[$COUNTER]},1p /opt/karoshi/serversetup/pdc/"useful scripts"/.alphabet`

let COUNTER=COUNTER+1

done
PASSWORD=`echo ${CHARACTER[@]:0} | sed 's/ //g'`
}

function nslcd-user-accounts {
#nslcd-server
random_pass
samba-tool user add nslcd-server --userou='CN=karoshi,CN=other,CN=Users' --use-username-as-cn --random-password 1>/dev/null 2>> /opt/karoshi/serversetup/install_log
samba-tool user setpassword nslcd-server --newpassword=$PASSWORD 1>/dev/null 2>> /opt/karoshi/serversetup/install_log

#Modify useraccountcontrol
echo -e "dn: CN=nslcd-server,CN=karoshi,CN=other,CN=Users,$LDAPBASE
changetype: modify
replace: userAccountControl
userAccountControl: 66112
-" | ldapmodify -x -D "CN=Administrator,CN=Users,$LDAPBASE" -w $LDAPPASS 1>/dev/null 2>> /opt/karoshi/serversetup/install_log

touch /opt/karoshi/server_network/domain_information/nslcd-server
chmod 0400 /opt/karoshi/server_network/domain_information/nslcd-server
echo $PASSWORD > /opt/karoshi/server_network/domain_information/nslcd-server

#nslcd-user
random_pass
samba-tool user add nslcd-user --userou='CN=karoshi,CN=other,CN=Users' --use-username-as-cn --random-password 1>/dev/null 2>> /opt/karoshi/serversetup/install_log
samba-tool user setpassword nslcd-user --newpassword=$PASSWORD 1>/dev/null 2>> /opt/karoshi/serversetup/install_log
#Modify useraccountcontrol
echo -e "dn: CN=nslcd-user,CN=karoshi,CN=other,CN=Users,$LDAPBASE
changetype: modify
replace: userAccountControl
userAccountControl: 66112
-" | ldapmodify -x -D "CN=Administrator,CN=Users,$LDAPBASE" -w $LDAPPASS 1>/dev/null 2>> /opt/karoshi/serversetup/install_log

touch /opt/karoshi/server_network/domain_information/nslcd-user
chmod 0400 /opt/karoshi/server_network/domain_information/nslcd-user
echo $PASSWORD > /opt/karoshi/server_network/domain_information/nslcd-user
}

function link_organisational_unit {

#Make a cn inside the ou
samba-tool group add --groupou="$SUBPATH" $NAME
#Add member to the group
echo -e "dn: $LDAPPATH
changetype: modify
add: member
member: $LDAPLINK
-" | ldapmodify -x -D "CN=Administrator,CN=Users,$LDAPBASE" -w $LDAPPASS
}

function link_organisational_units {

NAME=techpolicy
NAME2=tech
SUBPATH="OU=$NAME2,OU=personnel,OU=Policies"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

NAME=techlist
SUBPATH="OU=$NAME2,OU=personnel,OU=Distributionlists"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

NAME=itadminpolicy
NAME2=itadmin
SUBPATH="OU=$NAME2,OU=personnel,OU=Policies"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

NAME=itadminlist
SUBPATH="OU=$NAME2,OU=personnel,OU=Distributionlists"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

NAME=staffpolicy
NAME2=staff
SUBPATH="OU=$NAME2,OU=personnel,OU=Policies"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

NAME=stafflist
SUBPATH="OU=$NAME2,OU=personnel,OU=Distributionlists"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

NAME=studentstaffpolicy
NAME2=studentstaff
SUBPATH="OU=$NAME2,OU=personnel,OU=Policies"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

NAME=studentstafflist
SUBPATH="OU=$NAME2,OU=personnel,OU=Distributionlists"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

NAME=officestaffpolicy
NAME2=officestaff
SUBPATH="OU=$NAME2,OU=personnel,OU=Policies"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

NAME=officestafflist
SUBPATH="OU=$NAME2,OU=personnel,OU=Distributionlists"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

NAME=nonteachingstaffpolicy
NAME2=nonteachingstaff
SUBPATH="OU=$NAME2,OU=personnel,OU=Policies"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

NAME=nonteachingstafflist
SUBPATH="OU=$NAME2,OU=personnel,OU=Distributionlists"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

NAME=governorspolicy
NAME2=governors
SUBPATH="OU=$NAME2,OU=personnel,OU=Policies"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

NAME=governorslist
SUBPATH="OU=$NAME2,OU=personnel,OU=Distributionlists"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

COUNTER=$STARTYEAR
while [ $COUNTER -le $ENDYEAR ]
do

NAME="yr$COUNTER"policy
NAME2=yr$COUNTER
SUBPATH="OU=$NAME2,OU=students,OU=Policies"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

NAME="yr$COUNTER"list
SUBPATH="OU=$NAME2,OU=students,OU=Distributionlists"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

let COUNTER=$COUNTER+1
done

NAME=guestuserspolicy
NAME2=guestusers
SUBPATH="OU=$NAME2,OU=other,OU=Policies"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

NAME=guestuserslist
SUBPATH="OU=$NAME2,OU=other,OU=Distributionlists"
LDAPPATH="CN=$NAME,$SUBPATH,$LDAPBASE"
LDAPLINK="CN=$NAME2,CN=Groups,CN=Users,$LDAPBASE"
link_organisational_unit

}

function add_organisational_unit {
hour=`date +%H`
minutes=`date +%M`
seconds=`date +%S`
CREATETIME=$THISYEAR$MONTH$DAY$hour$minutes$seconds.0Z

echo -e "version: 1

# Entry 1: $LDAPPATH
dn: $LDAPPATH
ou: $NAME
description: $DESC
distinguishedname: $LDAPPATH
instancetype: 4
name: $NAME
objectcategory: CN=Organizational-Unit,CN=Schema,CN=Configuration,$LDAPBASE
objectclass: top
objectclass: organizationalUnit
usnchanged: 3372
usncreated: 3371
whenchanged: $CREATETIME
whencreated: $CREATETIME" | ldapadd -x -D "CN=Administrator,CN=Users,$LDAPBASE" -w $LDAPPASS
}

function add_organisational_units {

#Policies subcontainer
NAME="Policies"
DESC="Policies"
LDAPPATH="OU=Policies,$LDAPBASE"
add_organisational_unit

#Distributionlists subcontainer
NAME="Distributionlists"
DESC="Distribution lists"
LDAPPATH="OU=Distributionlists,$LDAPBASE"
add_organisational_unit

#All subcontainers for policies and distribution lists

NAME="personnel"
DESC="Personnel"
LDAPPATH="OU=personnel,OU=Policies,$LDAPBASE"
add_organisational_unit
LDAPPATH="OU=personnel,OU=Distributionlists,$LDAPBASE"
add_organisational_unit

NAME="staff"
DESC="Staff"
LDAPPATH="OU=staff,OU=personnel,OU=Policies,$LDAPBASE"
add_organisational_unit
LDAPPATH="OU=staff,OU=personnel,OU=Distributionlists,$LDAPBASE"
add_organisational_unit

NAME="studentstaff"
DESC="Student staff"
LDAPPATH="OU=studentstaff,OU=personnel,OU=Policies,$LDAPBASE"
add_organisational_unit
LDAPPATH="OU=studentstaff,OU=personnel,OU=Distributionlists,$LDAPBASE"
add_organisational_unit

NAME="officestaff"
DESC="Office staff"
LDAPPATH="OU=officestaff,OU=personnel,OU=Policies,$LDAPBASE"
add_organisational_unit
LDAPPATH="OU=officestaff,OU=personnel,OU=Distributionlists,$LDAPBASE"
add_organisational_unit

NAME="nonteachingstaff"
DESC="Non teaching staff"
LDAPPATH="OU=nonteachingstaff,OU=personnel,OU=Policies,$LDAPBASE"
add_organisational_unit
LDAPPATH="OU=nonteachingstaff,OU=personnel,OU=Distributionlists,$LDAPBASE"
add_organisational_unit

NAME="governors"
DESC="Governors"
LDAPPATH="OU=governors,OU=personnel,OU=Policies,$LDAPBASE"
add_organisational_unit
LDAPPATH="OU=governors,OU=personnel,OU=Distributionlists,$LDAPBASE"
add_organisational_unit

NAME="itadmin"
DESC="Itadmin users"
LDAPPATH="OU=itadmin,OU=personnel,OU=Policies,$LDAPBASE"
add_organisational_unit
LDAPPATH="OU=itadmin,OU=personnel,OU=Distributionlists,$LDAPBASE"
add_organisational_unit

NAME="tech"
DESC="Technician users"
LDAPPATH="OU=tech,OU=personnel,OU=Policies,$LDAPBASE"
add_organisational_unit
LDAPPATH="OU=tech,OU=personnel,OU=Distributionlists,$LDAPBASE"
add_organisational_unit

#All student sub containers

NAME="students"
DESC="Student accounts"
LDAPPATH="OU=students,OU=Policies,$LDAPBASE"
add_organisational_unit
LDAPPATH="OU=students,OU=Distributionlists,$LDAPBASE"
add_organisational_unit

COUNTER=$STARTYEAR
while [ $COUNTER -le $ENDYEAR ]
do
NAME="yr$COUNTER"
DESC="yr$COUNTER"
LDAPPATH="OU=yr$COUNTER,OU=students,OU=Policies,$LDAPBASE"
add_organisational_unit
LDAPPATH="OU=yr$COUNTER,OU=students,OU=Distributionlists,$LDAPBASE"
add_organisational_unit
let COUNTER=$COUNTER+1
done

#All other subcontainers
NAME="other"
DESC="Other users"
LDAPPATH="OU=other,OU=Policies,$LDAPBASE"
add_organisational_unit
LDAPPATH="OU=other,OU=Distributionlists,$LDAPBASE"
add_organisational_unit

NAME="exams"
DESC="Exam users"
LDAPPATH="OU=exams,OU=other,OU=Policies,$LDAPBASE"
add_organisational_unit
LDAPPATH="OU=exams,OU=other,OU=Distributionlists,$LDAPBASE"
add_organisational_unit

NAME="guestusers"
DESC="Guest users"
LDAPPATH="OU=guestusers,OU=other,OU=Policies,$LDAPBASE"
add_organisational_unit
LDAPPATH="OU=guestusers,OU=other,OU=Distributionlists,$LDAPBASE"
add_organisational_unit


NAME="karoshi"
DESC="Karoshi user"
LDAPPATH="OU=karoshi,OU=other,OU=Policies,$LDAPBASE"
add_organisational_unit
LDAPPATH="OU=karoshi,OU=other,OU=Distributionlists,$LDAPBASE"
add_organisational_unit

NAME="nogroup"
DESC="No group"
LDAPPATH="OU=nogroup,OU=other,OU=Policies,$LDAPBASE"
add_organisational_unit
LDAPPATH="OU=nogroup,OU=other,OU=Distributionlists,$LDAPBASE"
add_organisational_unit
}


function add_sub_container {

hour=`date +%H`
minutes=`date +%M`
seconds=`date +%S`
CREATETIME=$THISYEAR$MONTH$DAY$hour$minutes$seconds.0Z

echo -e "version: 1

# Entry 1: $LDAPPATH
dn: $LDAPPATH
cn: $NAME
description: $DESC
distinguishedname: $LDAPPATH
instancetype: 4
name: $NAME
objectcategory: CN=Container,CN=Schema,CN=Configuration,$LDAPBASE
objectclass: top
objectclass: container
showinadvancedviewonly: FALSE
systemflags: -1946157056
usnchanged: 3372
usncreated: 3371
whenchanged: $CREATETIME
whencreated: $CREATETIME" | ldapadd -x -D "CN=Administrator,CN=Users,$LDAPBASE" -w $LDAPPASS

}

function add_subcontainers {

#Groups subcontainer
NAME="Groups"
DESC="Groups"
LDAPPATH="CN=Groups,CN=Users,$LDAPBASE"
add_sub_container

#All personnel subcontainers

NAME="personnel"
DESC="Personnel"
LDAPPATH="CN=personnel,CN=Users,$LDAPBASE"
add_sub_container

NAME="staff"
DESC="Staff"
LDAPPATH="CN=staff,CN=personnel,CN=Users,$LDAPBASE"
add_sub_container

NAME="studentstaff"
DESC="Student staff"
LDAPPATH="CN=studentstaff,CN=personnel,CN=Users,$LDAPBASE"
add_sub_container

NAME="officestaff"
DESC="Office staff"
LDAPPATH="CN=officestaff,CN=personnel,CN=Users,$LDAPBASE"
add_sub_container

NAME="nonteachingstaff"
DESC="Non teaching staff"
LDAPPATH="CN=nonteachingstaff,CN=personnel,CN=Users,$LDAPBASE"
add_sub_container

NAME="governors"
DESC="Governors"
LDAPPATH="CN=governors,CN=personnel,CN=Users,$LDAPBASE"
add_sub_container

NAME="itadmin"
DESC="Itadmin users"
LDAPPATH="CN=itadmin,CN=personnel,CN=Users,$LDAPBASE"
add_sub_container

NAME="tech"
DESC="Technician users"
LDAPPATH="CN=tech,CN=personnel,CN=Users,$LDAPBASE"
add_sub_container

#All student sub containers

NAME="students"
DESC="Student accounts"
LDAPPATH="CN=students,CN=Users,$LDAPBASE"
add_sub_container

COUNTER=$STARTYEAR
while [ $COUNTER -le $ENDYEAR ]
do
NAME="yr$COUNTER"
DESC="yr$COUNTER"
LDAPPATH="CN=yr$COUNTER,CN=students,CN=Users,$LDAPBASE"
add_sub_container
let COUNTER=$COUNTER+1
done

#All other subcontainers
NAME="other"
DESC="Other users"
LDAPPATH="CN=other,CN=Users,$LDAPBASE"
add_sub_container

NAME="exams"
DESC="Exam users"
LDAPPATH="CN=exams,CN=other,CN=Users,$LDAPBASE"
add_sub_container

NAME="guestusers"
DESC="Guest users"
LDAPPATH="CN=guestusers,CN=other,CN=Users,$LDAPBASE"
add_sub_container

NAME="karoshi"
DESC="Karoshi user"
LDAPPATH="CN=karoshi,CN=other,CN=Users,$LDAPBASE"
add_sub_container

NAME="nogroup"
DESC="No group"
LDAPPATH="CN=nogroup,CN=other,CN=Users,$LDAPBASE"
add_sub_container
}

function add_samba4_group {
samba-tool group add --groupou="CN=Groups,CN=Users" $NEWGROUP

GIDNUMBER=`getent group $NEWGROUP | cut -d: -f3`
echo -e "dn: CN=$NEWGROUP,CN=Groups,CN=Users,$LDAPBASE
changetype: modify
add: objectclass
objectclass: posixgroup
-
add: gidnumber
gidnumber: $GIDNUMBER
-
add: displayname
displayname: "$NEWGROUPDISP"
-
add: mail
mail: $NEWGROUP@$REALM
-" | ldapmodify -x -D "CN=Administrator,CN=Users,$LDAPBASE" -w $LDAPPASS

}

##############################
#function Make the folders and groups
##############################
function makefoldersandgroups {
#Make Groups
COUNTER=$STARTYEAR
while [  $COUNTER -le $ENDYEAR ]; do
echo -e "$GROUPADDMSG yr$COUNTER\n"
NEWGROUP=yr$COUNTER
NEWGROUPDISP="Yr$COUNTER"
add_samba4_group
let COUNTER=COUNTER+1
done

echo -e "$GROUPADDMSG staff\n"
NEWGROUP=staff
NEWGROUPDISP=Staff
add_samba4_group

echo -e "$GROUPADDMSG nonteachingstaff\n"
NEWGROUP=nonteachingstaff
NEWGROUPDISP="Non teaching staff"
add_samba4_group

echo -e "$GROUPADDMSG studentstaff\n"
NEWGROUP=studentstaff
NEWGROUPDISP="Student Staff"
add_samba4_group

echo -e "$GROUPADDMSG guestusers\n"
NEWGROUP=guestusers
NEWGROUPDISP="Guest Users"
add_samba4_group

echo -e "$GROUPADDMSG exams\n"
NEWGROUP=exams
NEWGROUPDISP="Exam Users"
add_samba4_group

echo $GROUPADDMSG itadmin
NEWGROUP=itadmin
NEWGROUPDISP="Itadmin Users"
add_samba4_group

echo $GROUPADDMSG tech
NEWGROUP=tech
NEWGROUPDISP="Tech Users"
add_samba4_group

echo -e "$GROUPADDMSG officestaff\n"
NEWGROUP=officestaff
NEWGROUPDISP="Office Staff"
add_samba4_group

echo -e "$GROUPADDMSG bursar\n"
NEWGROUP=bursar
NEWGROUPDISP="Bursars"
add_samba4_group

echo -e "$GROUPADDMSG smt\n"
NEWGROUP=smt
NEWGROUPDISP="Senior Management"
add_samba4_group

echo -e "$GROUPADDMSG governors\n"
NEWGROUP=governors
NEWGROUPDISP="Governors"
add_samba4_group

echo -e "$GROUPADDMSG guardians\n"
NEWGROUP=guardians
NEWGROUPDISP="Guardians"
add_samba4_group

echo -e "$GROUPADDMSG profilemanagement\n"
NEWGROUP=profilemanagement
NEWGROUPDISP="Profile Management"
add_samba4_group

echo $CREATEHOMEFOLDERSMSG
#Make top level user area
chmod 0755 /home
chown root.root /home
[ -d /home/users ] || mkdir /home/users
chmod 0755 /home/users
chown root.root /home/users
#Student users home areas
[ -d /home/users/students ] || mkdir /home/users/students
chmod 0755 /home/users/students
chown root.root /home/users/students
COUNTER=$STARTYEAR
while [  $COUNTER -le $ENDYEAR ]; do
[ -d /home/users/students/yr$COUNTER ] || mkdir /home/users/students/yr$COUNTER
chmod 0750 /home/users/students/yr$COUNTER
chown root.yr$COUNTER /home/users/students/yr$COUNTER
chown .yr$COUNTER -R /home/users/students/yr$COUNTER
let COUNTER=COUNTER+1
done
#Staff users home areas
[ -d /home/users/staff ] || mkdir /home/users/staff
chmod 0750 /home/users/staff
chown root.staff /home/users/staff
chown .staff -R /home/users/staff
#Studentstaff users home areas
[ -d /home/users/studentstaff ] || mkdir /home/users/studentstaff
chmod 0750 /home/users/studentstaff
chown root.studentstaff /home/users/studentstaff
chown .studentstaff -R /home/users/studentstaff

#Guardian users home areas
[ -d /home/users/guardians ] || mkdir /home/users/guardians
chmod 0750 /home/users/guardians
chown root.guardians /home/users/guardians
chown .guardians -R /home/users/guardians

#Governor users home areas
[ -d /home/users/governors ] || mkdir /home/users/governors
chmod 0750 /home/users/governors
chown root.governors /home/users/governors
chown .governors -R /home/users/governors

#Non teaching staff users home areas
[ -d /home/users/nonteachingstaff ] || mkdir /home/users/nonteachingstaff
chmod 0750 /home/users/nonteachingstaff
chown root.nonteachingstaff /home/users/nonteachingstaff
chown .nonteachingstaff -R /home/users/nonteachingstaff
#Office staff users home area
[ -d /home/users/officestaff ] || mkdir /home/users/officestaff
chmod 0750 /home/users/officestaff
chown root.officestaff /home/users/officestaff
chown .officestaff -R /home/users/officestaff
#Tech staff users home area
[ -d /home/users/techstaff ] || mkdir /home/users/techstaff
chmod 0750 /home/users/techstaff
chown root.tech /home/users/techstaff
chown .tech -R /home/users/techstaff
#Itadmin staff users home area
[ -d /home/users/itadminstaff ] || mkdir /home/users/itadminstaff
chmod 0750 /home/users/itadminstaff
chown root.itadmin /home/users/itadminstaff
chown .itadmin -R /home/users/itadminstaff
#Guest users home area
[ -d /home/users/guests ] || mkdir /home/users/guests
chmod 0750 /home/users/guests
chown root.guestusers /home/users/guests
chown .guestusers -R /home/users/guests
#Exam users home area
[ -d /home/users/exams ] || mkdir /home/users/exams
chmod 0750 /home/users/exams
chown root.exams /home/users/exams
chown .exams -R /home/users/exams
#Applications area - windows profiles
echo $CREATEFOLDERMSG applications
[ -d /home/applications ] || mkdir /home/applications
if ! test -d /home/applications/backgrounds
then
mkdir /home/applications/backgrounds
cp /opt/karoshi/serversetup/pdc/backgrounds/* /home/applications/backgrounds/
cp /opt/karoshi/serversetup/all/backgrounds/* /home/applications/backgrounds/

COUNTER=2003
ENDYEAR=2080
while [ $COUNTER -le $ENDYEAR ]
do
cp /home/applications/backgrounds/students.bmp /home/applications/backgrounds/yr$COUNTER.bmp
let COUNTER=$COUNTER+1
done
fi

#News information for karoshi log in banner
[ -d /home/applications/news ] || mkdir /home/applications/news
if ! test -f /home/applications/news/news.txt
then
echo Welcome to the Karoshi Network > /home/applications/news/news.txt
echo >> /home/applications/news/news.txt
echo http://www.karoshi.org.uk >> /home/applications/news/news.txt
fi
chmod 0664 -R /home/applications
chmod u+X,g+X,o+X -R /home/applications
chown root.itadmin -R /home/applications
#Subjects area
echo $CREATEFOLDERMSG subjects
if ! test -d /home/subjects
then
mkdir /home/subjects /home/subjects/"work experience" /home/subjects/art /home/subjects/"business studies" /home/subjects/careers
mkdir /home/subjects/childcare /home/subjects/citizenship /home/subjects/drama /home/subjects/english /home/subjects/french
mkdir /home/subjects/geography /home/subjects/german /home/subjects/"health and social care" /home/subjects/history
mkdir /home/subjects/ict /home/subjects/"leisure and tourism" /home/subjects/literacy /home/subjects/mathematics /home/subjects/"media studies"
mkdir /home/subjects/music /home/subjects/olc /home/subjects/"physical education" /home/subjects/science /home/subjects/spanish
mkdir /home/subjects/welsh /home/subjects/technology
fi
chmod 0755 /home/subjects
chmod 2664 -R /home/subjects/*
chmod u+X,g+X,o+X -R  /home/subjects/*
chown root.itadmin /home/subjects
chown -R root.staff /home/subjects/*
#Staffshare area
echo $CREATEFOLDERMSG staffshare
[ -d /home/staffshare ] || mkdir /home/staffshare
[ -d /home/staffshare/temp ] || mkdir /home/staffshare/temp
[ -d /home/staffshare/"useful documents" ] || mkdir /home/staffshare/"useful documents"
[ -d /home/staffshare/smt ] || mkdir /home/staffshare/smt
[ -d /home/staffshare/"work experience" ] || mkdir /home/staffshare/"work experience"
[ -d /home/staffshare/art ] || mkdir /home/staffshare/art
[ -d /home/staffshare/"business studies" ] || mkdir /home/staffshare/"business studies"
[ -d /home/staffshare/careers ] || mkdir /home/staffshare/careers
[ -d /home/staffshare/childcare ] || mkdir /home/staffshare/childcare
[ -d /home/staffshare/citizenship ] || mkdir /home/staffshare/citizenship
[ -d /home/staffshare/drama ] || mkdir /home/staffshare/drama
[ -d /home/staffshare/english ] || mkdir /home/staffshare/english
[ -d /home/staffshare/french ] || mkdir /home/staffshare/french
[ -d /home/staffshare/geography ] || mkdir /home/staffshare/geography
[ -d /home/staffshare/german ] || mkdir /home/staffshare/german
[ -d /home/staffshare/"health and social care" ] || mkdir /home/staffshare/"health and social care"
[ -d /home/staffshare/history ] || mkdir /home/staffshare/history
[ -d /home/staffshare/ict ] || mkdir /home/staffshare/ict
[ -d /home/staffshare/"leisure and tourism" ] || mkdir /home/staffshare/"leisure and tourism"
[ -d /home/staffshare/literacy ] || mkdir /home/staffshare/literacy
[ -d /home/staffshare/mathematics ] || mkdir /home/staffshare/mathematics
[ -d /home/staffshare/"media studies" ] || mkdir /home/staffshare/"media studies"
[ -d /home/staffshare/music ] || mkdir /home/staffshare/music
[ -d /home/staffshare/olc ] || mkdir /home/staffshare/olc
[ -d /home/staffshare/"physical education" ] || mkdir /home/staffshare/"physical education"
[ -d /home/staffshare/science ] || mkdir /home/staffshare/science
[ -d /home/staffshare/spanish ] || mkdir /home/staffshare/spanish
[ -d /home/staffshare/welsh ] || mkdir /home/staffshare/welsh
[ -d /home/staffshare/technology ] || mkdir /home/staffshare/technology
chmod 0750 /home/staffshare
chmod 2660 -R /home/staffshare/*
chmod u+X,g+X /home/staffshare/*
chown -R root.staff /home/staffshare
chown root.smt -R /home/staffshare/smt

#Officeshare area
echo $CREATEFOLDERMSG officeshare
[ -d /home/officeshare ] || mkdir /home/officeshare
[ -d /home/officeshare/temp ] || mkdir /home/officeshare/temp
[ -d /home/officeshare/bursar ] || mkdir /home/officeshare/bursar

chmod 2660 -R /home/officeshare
chmod u+X,g+X -R /home/officeshare
chown -R root.officestaff /home/officeshare
chown root.bursar -R /home/officeshare/bursar
#Itadminshare area
echo $CREATEFOLDERMSG itadminshare
[ -d /home/itadminshare ] || mkdir /home/itadminshare
[ -d /home/itadminshare/"bulk user creation"/"input files" ] || mkdir -p /home/itadminshare/"bulk user creation"/"input files"
[ -d /home/itadminshare/documentation ] || mkdir /home/itadminshare/documentation
[ -d /home/itadminshare/temp ] || mkdir /home/itadminshare/temp
[ -d /home/itadminshare/"user data" ] || mkdir /home/itadminshare/"user data"
[ -d /home/itadminshare/other ] || mkdir /home/itadminshare/other

chown root.itadmin -R /home/itadminshare
chmod 0660 -R /home/itadminshare
chmod u+X,g+X -R /home/itadminshare
#Karoshi log area
[ -d /var/log/karoshilogs ] || mkdir /var/log/karoshilogs
chmod 0373 /var/log/karoshilogs
chown root.itadmin -R /var/log/karoshilogs


[ -d /var/lib/samba/netlogon ] || mkdir /var/lib/samba/netlogon
##############################
#Check if STARTYEAR is even, bash is rounding down on decimal places
##############################
let YEARCHECK=STARTYEAR/2
let YEARCHECK=YEARCHECK*2
if [ $YEARCHECK = $STARTYEAR ]
then
let ORACCOUNTER=STARTYEAR
let JOSHUACOUNTER=STARTYEAR+1
else
let ORACCOUNTER=STARTYEAR+1
let JOSHUACOUNTER=STARTYEAR
fi
#############################
#Copy in logon files
#############################
echo $COPYLOGONFILESMSG
[ ! -d /var/lib/samba/netlogon ] || cp -R /var/lib/samba/netlogon /var/lib/samba/netlogon_`date +%s`
cp -R /opt/karoshi/serversetup/pdc/logonscripts/* /var/lib/samba/netlogon/
chmod 0644 /var/lib/samba/netlogon/*
chmod 0660 /var/lib/samba/netlogon/kix/reclassify.bat
chown root.itadmin /var/lib/samba/netlogon/kix/reclassify.bat

#############################
#Modify logon forms to match servername
#############################
sed -i "s/CHANGETHISDOMAINNAME/$SAMBADOMAIN/g" /var/lib/samba/netlogon/logonform.kix
sed -i "s/CHANGETHISDOMAINNAME/$SAMBADOMAIN/g" /var/lib/samba/netlogon/newlogonform.kix
sed -i 's/CHANGETHISHOSTNAME/'$HOSTNAME'/g' /var/lib/samba/netlogon/logonform.kix
sed -i 's/CHANGETHISHOSTNAME/'$HOSTNAME'/g' /var/lib/samba/netlogon/newlogonform.kix
sed -i 's/CHANGETHISHOSTNAME/'$HOSTNAME'/g' /var/lib/samba/netlogon/logon.bat
sed -i 's/CHANGETHISHOSTNAME/'$HOSTNAME'/g' /var/lib/samba/netlogon/kixtart_install.bat
sed -i 's/CHANGETHISHOSTNAME/'$HOSTNAME'/g' /var/lib/samba/netlogon/getdll.bat
sed -i 's/CHANGETHISHOSTNAME/'$HOSTNAME'/g' /var/lib/samba/netlogon/kixforms_upgrade.bat
sed -i 's/CHANGETHISHOSTNAME/'$HOSTNAME'/g' /var/lib/samba/netlogon//kix/reclassify.bat

#############################
#make group file information for kixtart windows logon script
#############################
echo exams,$HOSTNAME > /var/lib/samba/netlogon/groups.txt
echo itadmin,$HOSTNAME >> /var/lib/samba/netlogon/groups.txt
echo guestusers,$HOSTNAME >> /var/lib/samba/netlogon/groups.txt
echo guardians,$HOSTNAME >> /var/lib/samba/netlogon/groups.txt
echo governors,$HOSTNAME >> /var/lib/samba/netlogon/groups.txt
echo nonteachingstaff,$HOSTNAME >> /var/lib/samba/netlogon/groups.txt
echo officestaff,$HOSTNAME >> /var/lib/samba/netlogon/groups.txt
echo profileuser,$HOSTNAME >> /var/lib/samba/netlogon/groups.txt
echo staff,$HOSTNAME >> /var/lib/samba/netlogon/groups.txt
echo studentstaff,$HOSTNAME >> /var/lib/samba/netlogon/groups.txt
echo Domain Admins,$HOSTNAME >> /var/lib/samba/netlogon/groups.txt

COUNTER=$STARTYEAR
         while [  $COUNTER -le $ENDYEAR ]; do
		echo yr$COUNTER,$HOSTNAME >> /var/lib/samba/netlogon/groups.txt
		let COUNTER=COUNTER+1
         done

########################
#Add in windows settings
########################
if [ ! -d /var/lib/samba/netlogon/windows_settings/security ]
then
mkdir -p /var/lib/samba/netlogon/windows_settings/security
ln -s /var/lib/samba/netlogon/staffdtsec.kix /var/lib/samba/netlogon/windows_settings/security/staff.kix
ln -s /var/lib/samba/netlogon/officestaffdtsec.kix /var/lib/samba/netlogon/windows_settings/security/officestaff.kix
ln -s /var/lib/samba/netlogon/guestdtsec.kix /var/lib/samba/netlogon/windows_settings/security/guest.kix
ln -s /var/lib/samba/netlogon/techdtsec.kix /var/lib/samba/netlogon/windows_settings/security/tech.kix
ln -s /var/lib/samba/netlogon/examdtsec.kix /var/lib/samba/netlogon/windows_settings/security/exams.kix
ln -s /var/lib/samba/netlogon/itadmindtsec.kix /var/lib/samba/netlogon/windows_settings/security/itadminstaff.kix

COUNTER=2000
ENDYEAR=2050
while [ $COUNTER -le $ENDYEAR ]
do
ln -s /var/lib/samba/netlogon/studentdtsec.kix /var/lib/samba/netlogon/windows_settings/security/yr$COUNTER.kix
let COUNTER=$COUNTER+1
done
fi

if [ ! -d /var/lib/samba/netlogon/windows_settings/drives ]
then
mkdir -p /var/lib/samba/netlogon/windows_settings/drives
cp -f -R /opt/karoshi/serversetup/pdc/logonscripts/drives/* /var/lib/samba/netlogon/windows_settings/drives/

for DRIVEFILES in /var/lib/samba/netlogon/windows_settings/drives/*
do
DRIVEFILE=`basename "$DRIVEFILES"`
sed -i 's/CHANGETHISHOSTNAME/'$HOSTNAME'/g' "/var/lib/samba/netlogon/windows_settings/drives/$DRIVEFILE"
done 

COUNTER=2000
ENDYEAR=2050
while [ $COUNTER -le $ENDYEAR ]
do
ln -s /var/lib/samba/netlogon/windows_settings/drives/students.kix /var/lib/samba/netlogon/windows_settings/drives/yr$COUNTER.kix
let COUNTER=$COUNTER+1
done
fi

#############################
#make group file information for web management logon information
#############################
source /opt/karoshi/serversetup/variables/years
[ ! -d /opt/karoshi/server_network/group_information ] && mkdir -p /opt/karoshi/server_network/group_information

function make_primary_group_info {
echo SERVER'='$HOSTNAME > /opt/karoshi/server_network/group_information/$PRIMARY_GROUP
echo HOMEPATH'='$HOMEPATH >> /opt/karoshi/server_network/group_information/$PRIMARY_GROUP
echo SUBUNIT'='$SUBUNIT >> /opt/karoshi/server_network/group_information/$PRIMARY_GROUP
echo SECONDARYGROUP'='$SECONDARYGROUP >> /opt/karoshi/server_network/group_information/$PRIMARY_GROUP
echo YEARSUFFIX'='$YEARSUFFIX >> /opt/karoshi/server_network/group_information/$PRIMARY_GROUP
}

PRIMARY_GROUP=profilemanagement
SUBUNIT=other
HOMEPATH=/home/users/
make_primary_group_info
PRIMARY_GROUP=guestusers
SUBUNIT=other
HOMEPATH=/home/users/guestusers
make_primary_group_info
PRIMARY_GROUP=governors
SUBUNIT=personnel
HOMEPATH=/home/users/governors
make_primary_group_info
PRIMARY_GROUP=guardians
SUBUNIT=trustees
HOMEPATH=/home/users/guardians
make_primary_group_info
PRIMARY_GROUP=staff
SUBUNIT=personnel
HOMEPATH=/home/users/staff
make_primary_group_info
PRIMARY_GROUP=nonteachingstaff
SUBUNIT=personnel
HOMEPATH=/home/users/nonteachingstaff
make_primary_group_info
PRIMARY_GROUP=officestaff
SUBUNIT=personnel
HOMEPATH=/home/users/officestaff
SECONDARYGROUP=staff
make_primary_group_info
PRIMARY_GROUP=studentstaff
SUBUNIT=personnel
HOMEPATH=/home/users/studentstaff
SECONDARYGROUP=""
make_primary_group_info
PRIMARY_GROUP=tech
SUBUNIT=personnel
HOMEPATH=/home/users/techstaff
make_primary_group_info
PRIMARY_GROUP=itadmin
SUBUNIT=personnel
HOMEPATH=/home/users/itadminstaff
SECONDARYGROUP="staff,tech"
make_primary_group_info
COUNTER=$STARTYEAR
SECONDARYGROUP=""
while [ $COUNTER -le $ENDYEAR ]
do
PRIMARY_GROUP=yr$COUNTER
SUBUNIT=students
HOMEPATH=/home/users/students/yr$COUNTER
YEARSUFFIX=${COUNTER:2}
make_primary_group_info
let COUNTER=$COUNTER+1
done

#######################
#Make printers.txt
#######################
if ! test -e /var/lib/samba/netlogon/printers.txt
then
echo '**********************************************************************' > /var/lib/samba/netlogon/printers.txt
echo '*'Printer names must match share names on the printer server >> /var/lib/samba/netlogon/printers.txt
echo '*'Supports a maximum of 10 printers per location >> /var/lib/samba/netlogon/printers.txt
echo '*'List your printers below the start marker >> /var/lib/samba/netlogon/printers.txt
echo '*'Do NOT remove or alter start marker >> /var/lib/samba/netlogon/printers.txt
echo '*' >> /var/lib/samba/netlogon/printers.txt
echo '*'Format: Location,Numberofprinters,Printer1,Printer2,....,DefaultPrinter >> /var/lib/samba/netlogon/printers.txt
echo '*'Example: R101,2,R101_BW,R101_CL,R101_BW >> /var/lib/samba/netlogon/printers.txt
echo '**********************************************************************' >> /var/lib/samba/netlogon/printers.txt
echo >> /var/lib/samba/netlogon/printers.txt
echo --start-- >> /var/lib/samba/netlogon/printers.txt
chmod 0644 /var/lib/samba/netlogon/printers.txt
fi
}

function make_profiles {
###################################
#Copying profiles
###################################
[ -d /home/remastersys ] && rm -f -R /home/remastersys
echo $COPYPROFILEMSG
[ ! -d /home/applications/profiles ] && mkdir /home/applications/profiles
[ ! -d /home/applications/profiles/defaultprofile ] && cp -R /opt/karoshi/serversetup/pdc/profiles/defaultprofile /home/applications/profiles/
[ ! -d /home/applications/profiles/profileuser ] && cp -R /opt/karoshi/serversetup/pdc/profiles/profileuser /home/applications/profiles/
[ ! -d /home/applications/profiles/default_roaming_profile ] && cp -R /opt/karoshi/serversetup/pdc/profiles/default_roaming_profile /home/applications/profiles/
COUNTER=$STARTYEAR
while [  $COUNTER -le $ENDYEAR ]; do
if [ ! -d /home/applications/profiles/yr$COUNTER ]
then
echo $COPYPROFILEMSG2 yr$COUNTER
cp -f -R /home/applications/profiles/defaultprofile /home/applications/profiles/yr$COUNTER
fi
let COUNTER=COUNTER+1
done
if [ ! -d /home/applications/profiles/guestusers ]
then
echo $COPYPROFILEMSG2 guestusers
cp -f -R /home/applications/profiles/defaultprofile /home/applications/profiles/guestusers
cp -f -R /opt/karoshi/serversetup/pdc/profiles/guestusers /home/applications/profiles/
fi
if [ ! -d /home/applications/profiles/exams ]
then
echo $COPYPROFILEMSG2 exams
cp -f -R /home/applications/profiles/defaultprofile /home/applications/profiles/exams
rm -f /home/applications/profiles/exams/Desktop/*
fi
if [ ! -d /home/applications/profiles/itadmin ]
then
echo $COPYPROFILEMSG2 itadmin
cp -f -R /home/applications/profiles/defaultprofile /home/applications/profiles/itadmin
cp -f -R /opt/karoshi/serversetup/pdc/profiles/itadmin /home/applications/profiles/
fi
if [ ! -d /home/applications/profiles/staff ]
then
echo $COPYPROFILEMSG2 staff
cp -f -R /home/applications/profiles/defaultprofile /home/applications/profiles/staff
cp -f -R /opt/karoshi/serversetup/pdc/profiles/staff /home/applications/profiles/
fi
if [ ! -d /home/applications/profiles/tech ]
then
echo $COPYPROFILEMSG2 tech
cp -f -R /home/applications/profiles/defaultprofile /home/applications/profiles/tech
cp -f -R /opt/karoshi/serversetup/pdc/profiles/tech /home/applications/profiles/
fi
if [ ! -d /home/applications/profiles/officestaff ]
then
echo $COPYPROFILEMSG2 officestaff
cp -f -R /home/applications/profiles/defaultprofile /home/applications/profiles/officestaff
cp -f -R /opt/karoshi/serversetup/pdc/profiles/officestaff /home/applications/profiles/
fi
if [ ! -d /home/applications/profiles/studentstaff ]
then
echo $COPYPROFILEMSG2 studentstaff
cp -f -R /home/applications/profiles/defaultprofile /home/applications/profiles/studentstaff
cp -f -R /opt/karoshi/serversetup/pdc/profiles/studentstaff /home/applications/profiles/
fi
if [ ! -d /home/applications/profiles/nonteachingstaff ]
then
echo $COPYPROFILEMSG2 nonteachingstaff
cp -f -R /home/applications/profiles/defaultprofile /home/applications/profiles/nonteachingstaff
cp -f -R /opt/karoshi/serversetup/pdc/profiles/nonteachingstaff /home/applications/profiles/
fi
echo $COPYPROFILEMSG2 governors
cp -f -R /home/applications/profiles/defaultprofile /home/applications/profiles/governors
cp -f -R /opt/karoshi/serversetup/pdc/profiles/governors /home/applications/profiles/
echo $COPYPROFILEMSG2 guardians
cp -f -R /home/applications/profiles/defaultprofile /home/applications/profiles/guardians
cp -f -R /opt/karoshi/serversetup/pdc/profiles/guardians /home/applications/profiles/

echo $SETPROFILEPERMSMSG
chown -R root.itadmin /home/applications/profiles
chmod 0664 -R /home/applications/profiles
chmod u+X,g+X,o+X -R /home/applications/profiles
[ -d /home/applications/Shortcuts ] || cp -R /opt/karoshi/serversetup/pdc/Shortcuts /home/applications
chown -R root.itadmin /home/applications/Shortcuts
chmod 0664 -R /home/applications/Shortcuts
chmod u+X,g+X,o+X -R /home/applications/Shortcuts
chmod 0600 -R /home/applications/profiles/profileuser
chmod u+X -R /home/applications/profiles/profileuser
chown -R profileuser /home/applications/profiles/profileuser
[ -d /home/applications/"profile management" ] || mkdir /home/applications/"profile management"
[ -d /home/applications/"profile management"/"desktop icons" ] || mkdir /home/applications/"profile management"/"desktop icons"
[ -d /home/applications/"profile management"/"start menu" ] || mkdir /home/applications/"profile management"/"start menu"
[ -d /home/applications/"profile management"/"new profile" ] || mkdir /home/applications/"profile management"/"new profile"
chown -R root.itadmin /home/applications/"profile management"
chmod 0660 -R /home/applications/"profile management"
chmod u+X,g+X -R /home/applications/"profile management"

#Link V2 profiles 
for PROFILES in /home/applications/profiles/*
do
PROFILE=`basename $PROFILES`
if [ -d /home/applications/profiles/$PROFILE ] && [ ! -L /home/applications/profiles/$PROFILE ] && [ ! -L /home/applications/profiles/$PROFILE.V2 ]
then
echo Symlinking $PROFILE to $PROFILE.V2
ln -s /home/applications/profiles/$PROFILE /home/applications/profiles/$PROFILE.V2
fi
done


[ -d /var/lib/samba/printers ] || mkdir /var/lib/samba/printers
chown -R root.itadmin /var/lib/samba/printers
chmod 0775 -R /var/lib/samba/printers
[ ! -d /var/spool/samba ] && mkdir -p /var/spool/samba
chmod 0777 /var/spool/samba
chmod +t /var/spool/samba
[ ! -d /home/applications/cups_print/x64 ] && mkdir -p /home/applications/cups_print/x64

chmod 0775 -R /home/applications/cups_print
chown root.tech -R /home/applications/cups_print

chmod 0444 -R /var/lib/samba/netlogon/*
chmod u+X,g+X,o+X -R /var/lib/samba/netlogon/*
chmod 0555 /var/lib/samba/netlogon/logon.bat
chmod 0555 /var/lib/samba/netlogon/kixtart_install.bat
chmod 0555 /var/lib/samba/netlogon/getdll.bat
chmod 0555 /var/lib/samba/netlogon/kix/reclassify.bat
}

echo EXTRASERVERS'='no > /opt/karoshi/serversetup/variables/choice
echo EXTRASERVERCOUNT'='1 >> /opt/karoshi/serversetup/variables/choice

function allow_anonumous_browse {
#Modify CN=Directory Service to allow anonymous ldap bind
echo -e "dn: CN=Directory Service,CN=Windows NT,CN=Services,CN=Configuration,$LDAPBASE
changetype: modify
add: dsHeuristics
dsHeuristics: 0000002001001
-" | ldapmodify -x -D "CN=Administrator,CN=Users,$LDAPBASE" -w $LDAPPASS 1>/dev/null 2>> /opt/karoshi/serversetup/install_log
}


function create_user {
samba-tool user add $NEWUSERNAME --userou="$SUBPATH" --profile-path=\\\\$HOSTNAME\\applications\\profiles\\$PRIMARYGROUP --script-path=logon.bat --use-username-as-cn  --random-password --mail-address=$NEWUSERNAME@$REALM 1>/dev/null 2>>/opt/karoshi/serversetup/install_log

#Add user to primary group
samba-tool group addmembers "$PRIMARYGROUP" $NEWUSERNAME  1>/dev/null 2>>/opt/karoshi/serversetup/install_log

#Add tech and itadmin users to the domain admins group
if [ $PRIMARYGROUP = itadmin ] || [ $PRIMARYGROUP = tech ]
then
samba-tool group addmembers "Domain Admins" $NEWUSERNAME  1>/dev/null 2>>/opt/karoshi/serversetup/install_log
fi

#Change primarygroupid and add unixhomedirectory - have to use ldapmodify at this time since samba-tool does not seem to have this option!
#This is hideous why cant samba4 ldap do this all in one go??
echo -e "dn: CN=$NEWUSERNAME,$SUBPATH,$LDAPBASE
changetype: modify
add: objectclass
objectclass: posixaccount
-" | ldapmodify -x -D "CN=Administrator,CN=Users,$LDAPBASE" -w $LDAPPASS 1>/dev/null 2>>/opt/karoshi/serversetup/install_log

PRIGROUPID=`getent group $PRIMARYGROUP | cut -d: -f3`

echo -e "dn: CN=$NEWUSERNAME,$SUBPATH,$LDAPBASE
changetype: modify
add: gidnumber
gidnumber: $PRIGROUPID
-" | ldapmodify -x -D "CN=Administrator,CN=Users,$LDAPBASE" -w $LDAPPASS 1>/dev/null 2>>/opt/karoshi/serversetup/install_log

UIDNUMBER=`getent passwd $NEWUSERNAME | cut -d: -f3`

echo -e "dn: CN=$NEWUSERNAME,$SUBPATH,$LDAPBASE
changetype: modify
add: uidnumber
uidnumber: $UIDNUMBER
-" | ldapmodify -x -D "CN=Administrator,CN=Users,$LDAPBASE" -w $LDAPPASS 1>/dev/null 2>>/opt/karoshi/serversetup/install_log

echo -e "dn: CN=$NEWUSERNAME,$SUBPATH,$LDAPBASE
changetype: modify
add: unixhomedirectory
unixhomedirectory: $NEWUSERPATH
-" | ldapmodify -x -D "CN=Administrator,CN=Users,$LDAPBASE" -w $LDAPPASS 1>/dev/null 2>>/opt/karoshi/serversetup/install_log

[ ! -d $NEWUSERPATH ] && mkdir $NEWUSERPATH
chmod 0600 -R $NEWUSERPATH
chmod u+X -R $NEWUSERPATH
chown $NEWUSERNAME -R $NEWUSERPATH

}


function make_default_users {
#Get samba 4 database password
LDAPPASS=`sed -n 1,1p /etc/ldap.secret`

#Add profileuser
NEWUSERNAME=profileuser
NEWUSERPATH=/home/users/profileuser
SUBPATH='CN=other,CN=Users'
PRIMARYGROUP=profilemanagement
create_user

#Add guest accounts
COUNTER=1
while [  $COUNTER -le 10 ]
do
NEWUSERNAME=guest$COUNTER
NEWUSERPATH=/home/users/guests/guest$COUNTER
SUBPATH='CN=guestusers,CN=other,CN=Users'
PRIMARYGROUP=guestusers
create_user
let COUNTER=COUNTER+1
done

#Add tech accounts
COUNTER=1
while [  $COUNTER -le 4 ]
do
NEWUSERNAME=tech$COUNTER
NEWUSERPATH=/home/users/techstaff/tech$COUNTER
SUBPATH='CN=tech,CN=personnel,CN=Users'
PRIMARYGROUP=tech
create_user
let COUNTER=COUNTER+1
done
}

##############################
#Display progress box
##############################
function run_functions {
check_ldap_port
allow_anonumous_browse
add_subcontainers
add_organisational_units
#nslcd-user-accounts - not needed using anonymous bind instead
echo "N.A.:127.0.0.1:N.A.:$HOSTNAME:users:internal:" | /opt/karoshi/serversetup/modules/authentication/configure_authentication
makefoldersandgroups
link_organisational_units
make_default_users
make_profiles
getyadpid
if [ $YADPID'null' != null ]
then
kill $YADPID
fi
}

run_functions 2>> /opt/karoshi/serversetup/install_log | show_info
#######################
#Change passwords
#######################
echo root:"$SAMBAROOTPASSWORD1" | chpasswd
echo karoshi:"$SAMBAROOTPASSWORD1" | chpasswd

#######################
#Store and encrypt password "for" later use
#######################
grep -w root /etc/shadow | cut -d: -f2 | gpg --no-tty --passphrase-fd 0 -c /opt/karoshi/.tempdata/sambapassword
rm -f /opt/karoshi/.tempdata/sambapassword
mv -f /opt/karoshi/.tempdata/sambapassword.gpg /opt/karoshi/serversetup/variables/initial_password.gpg
chmod 0600 /opt/karoshi/serversetup/variables/initial_password.gpg

#######################
#Stop password aging
#######################
chage -M 99999 root
chage -M 99999 karoshi

#######################
#Setup Scheduled Jobs
#######################
[ -d /opt/karoshi/cronjobs/jobs ] || mkdir -p /opt/karoshi/cronjobs/jobs
echo 0 0 '*' '*' 7 /opt/karoshi/'"'useful scripts'"'/resetguestaccounts > /opt/karoshi/cronjobs/jobs/resetguestaccounts.cron
echo 1 0 '*' '*' 1-5 /opt/karoshi/'"'useful scripts'"'/resettechaccounts > /opt/karoshi/cronjobs/jobs/resettechaccounts.cron
echo 20 0 '*' '*' 1-5 rm -d -R -f /home/temparea/'*' > /opt/karoshi/cronjobs/jobs/tidytemparea.cron
echo 30 0 '*' '*' 1-5 rm -d -R -f /home/staffshare/temp/'*' > /opt/karoshi/cronjobs/jobs/tidystafftemparea.cron
echo 40 0 '*' '*' 1-5 rm -d -R -f /home/officeshare/temp/'*' > /opt/karoshi/cronjobs/jobs/tidyofficetemp.cron
/opt/karoshi/serversetup/all/"useful scripts"/refreshcronjobs

#########################
#Linux Client support
#########################
[ ! -d /var/lib/samba/netlogon/linuxclient ] && mkdir -p /var/lib/samba/netlogon/linuxclient
cp -f -R /opt/karoshi/serversetup/pdc/linuxclient/karoshi-2.2 /var/lib/samba/netlogon/linuxclient/

#Create pam_mount.conf.xml
/opt/karoshi/serversetup/pdc/"useful scripts"/generate_pam_mount

cp -f /opt/karoshi/serversetup/all/backgrounds/linuxclient.png /var/lib/samba/netlogon/linuxclient/background.png

#Create client info on netlogon
[ ! -d /var/lib/samba/netlogon/domain_information ] && mkdir -p /var/lib/samba/netlogon/domain_information
echo $SAMBADOMAIN > /var/lib/samba/netlogon/domain_information/domain_name
echo $HOSTNAME > /var/lib/samba/netlogon/domain_information/main_server

#Copy printer info to netlogon
[ -f /opt/karoshi/server_network/printserver ] && cp -f /opt/karoshi/server_network/printserver /var/lib/samba/netlogon/

#Add karoshi-2.2to versions.txt
touch /var/lib/samba/netlogon/linuxclient/versions.txt
[ `grep -c ^karoshi-2.2 /var/lib/samba/netlogon/linuxclient/versions.txt` = 0 ] && echo karoshi-2.2 >> /var/lib/samba/netlogon/linuxclient/versions.txt

#Point icons at the correct path
sed -i 's/xen:50001/manage.'$REALM':50001/g' /var/lib/samba/netlogon/linuxclient/karoshi-2.2/desktop_icons/all/"Change Password.desktop"
sed -i 's/xen:50001/manage.'$REALM':50001/g' /var/lib/samba/netlogon/linuxclient/karoshi-2.2/desktop_icons/itadmin/"Helpdesk.desktop"
sed -i 's/xen:50001/manage.'$REALM':50001/g' /var/lib/samba/netlogon/linuxclient/karoshi-2.2/desktop_icons/itadmin/"karoshimanagement.desktop"
sed -i 's/xen:50001/manage.'$REALM':50001/g' /var/lib/samba/netlogon/linuxclient/karoshi-2.2/desktop_icons/staff/"Helpdesk.desktop"
sed -i 's/xen:50001/manage.'$REALM':50001/g' /var/lib/samba/netlogon/linuxclient/karoshi-2.2/desktop_icons/staff/"karoshimanagement.desktop"
sed -i 's/xen:50001/manage.'$REALM':50001/g' /var/lib/samba/netlogon/linuxclient/karoshi-2.2/desktop_icons/officestaff/"Helpdesk.desktop"
sed -i 's/xen:50001/manage.'$REALM':50001/g' /var/lib/samba/netlogon/linuxclient/karoshi-2.2/desktop_icons/officestaff/"karoshimanagement.desktop"

#Create zone information
[ ! -d /opt/karoshi/server_network/zones/internal/primary_domain_controller ] && mkdir -p /opt/karoshi/server_network/zones/internal/primary_domain_controller
echo $HOSTNAME > /opt/karoshi/server_network/zones/internal/primary_domain_controller/$HOSTNAME

#Create information for linux clients
[ ! -d /var/lib/samba/netlogon/domain_information ] && mkdir -p /var/lib/samba/netlogon/domain_information
touch /var/lib/samba/netlogon/domain_information/samba4
echo $WEBADDRESS > /var/lib/samba/netlogon/domain_information/dns_domain
echo $DOMAINSID > /var/lib/samba/netlogon/domain_information/domain_sid
echo $LDAPBASE > /var/lib/samba/netlogon/domain_information/ldap_base

#Link domain_information to /home/applications
ln -s /var/lib/samba/netlogon/domain_information/ /home/applications

#Restart samba
echo Restarting samba4 >> /opt/karoshi/serversetup/install_log
/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/control_services/samba_stop
sleep 1
/opt/karoshi/serversetup/distro/$DISTROCHOICE/scripts/control_services/samba_start
#Wait for port  on localhost to be available
check_ldap_port
exit
